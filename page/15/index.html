<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/blog/uploads/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/blog/uploads/favicon.ico">
  <link rel="mask-icon" href="/blog/images/logo.svg" color="#222">

<link rel="stylesheet" href="/blog/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.0/css/all.min.css" integrity="sha256-AbA177XfpSnFEvgpYu1jMygiLabzPCJCRIBtR5jGc0k=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/themes/blue/pace-theme-minimal.css">
  <script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"dunwu.github.io","root":"/blog/","images":"/blog/images","scheme":"Pisces","darkmode":true,"version":"8.13.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":true,"nav":null,"activeClass":"gitalk"},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/blog/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/blog/js/config.js"></script>

    <meta name="description" content="钝悟的个人博客">
<meta property="og:type" content="website">
<meta property="og:title" content="Dunwu Blog">
<meta property="og:url" content="https://dunwu.github.io/blog/page/15/index.html">
<meta property="og:site_name" content="Dunwu Blog">
<meta property="og:description" content="钝悟的个人博客">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="钝悟 ◾ Dunwu">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://dunwu.github.io/blog/page/15/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/15/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Dunwu Blog</title>
  






  <noscript>
    <link rel="stylesheet" href="/blog/css/noscript.css">
  </noscript>
<style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/blog/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Dunwu Blog</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">大道至简，知易行难</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/blog/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/blog/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/blog/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">258</span></a></li><li class="menu-item menu-item-categories"><a href="/blog/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">118</span></a></li><li class="menu-item menu-item-archives"><a href="/blog/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">365</span></a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="钝悟 ◾ Dunwu"
      src="/blog/uploads/avatar.gif">
  <p class="site-author-name" itemprop="name">钝悟 ◾ Dunwu</p>
  <div class="site-description" itemprop="description">钝悟的个人博客</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/blog/archives/">
          <span class="site-state-item-count">365</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/blog/categories/">
        <span class="site-state-item-count">118</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/blog/tags/">
        <span class="site-state-item-count">258</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/dunwu" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;dunwu" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:forbreak@163.com" title="E-Mail → mailto:forbreak@163.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>
  <div class="cc-license site-overview-item animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdn.jsdelivr.net/npm/@creativecommons/vocabulary@2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>



        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/dunwu/blog" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/pages/7efbac/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/avatar.gif">
      <meta itemprop="name" content="钝悟 ◾ Dunwu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu Blog">
      <meta itemprop="description" content="钝悟的个人博客">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Dunwu Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/pages/7efbac/" class="post-title-link" itemprop="url">MongoDB 的 CRUD 操作</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-09-25 21:23:41" itemprop="dateCreated datePublished" datetime="2020-09-25T21:23:41+08:00">2020-09-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-09-23 18:54:25" itemprop="dateModified" datetime="2022-09-23T18:54:25+08:00">2022-09-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">数据库</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/%E6%96%87%E6%A1%A3%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">文档数据库</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/%E6%96%87%E6%A1%A3%E6%95%B0%E6%8D%AE%E5%BA%93/MongoDB/" itemprop="url" rel="index"><span itemprop="name">MongoDB</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>5.9k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>5 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="MongoDB-的-CRUD-操作"><a href="#MongoDB-的-CRUD-操作" class="headerlink" title="MongoDB 的 CRUD 操作"></a>MongoDB 的 CRUD 操作</h1><h2 id="一、基本-CRUD-操作"><a href="#一、基本-CRUD-操作" class="headerlink" title="一、基本 CRUD 操作"></a>一、基本 CRUD 操作</h2><p>MongoDB 的 CRUD 操作是针对 document 的读写操作。</p>
<h3 id="Create-操作"><a href="#Create-操作" class="headerlink" title="Create 操作"></a>Create 操作</h3><p>MongoDB 提供以下操作向一个 collection 插入 document</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/method/db.collection.insertOne/#db.collection.insertOne"><code>db.collection.insertOne()</code></a>：插入一条 document</li>
<li><a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/method/db.collection.insertMany/#db.collection.insertMany"><code>db.collection.insertMany()</code></a>：插入多条 document</li>
</ul>
<blockquote>
<p>注：以上操作都是原子操作。</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/snap/20200924112342.svg" alt="img"></p>
<p>插入操作的特性：</p>
<ul>
<li>MongoDB 中的所有写操作都是单个文档级别的原子操作。</li>
<li>如果要插入的 collection 当前不存在，则插入操作会自动创建 collection。</li>
<li>在 MongoDB 中，存储在集合中的每个文档都需要一个唯一的 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/glossary/#term-id"><code>_id</code></a> 字段作为主键。如果插入的文档省略 <code>_id</code> 字段，则 MongoDB 驱动程序会自动为 <code>_id</code> 字段生成 ObjectId。</li>
<li>可以 MongoDB 写入操作的确认级别来控制写入行为。</li>
</ul>
<p>【示例】插入一条 document 示例</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="property">inventory</span>.<span class="title function_">insertOne</span>(&#123;</span><br><span class="line">  <span class="attr">item</span>: <span class="string">&#x27;canvas&#x27;</span>,</span><br><span class="line">  <span class="attr">qty</span>: <span class="number">100</span>,</span><br><span class="line">  <span class="attr">tags</span>: [<span class="string">&#x27;cotton&#x27;</span>],</span><br><span class="line">  <span class="attr">size</span>: &#123; <span class="attr">h</span>: <span class="number">28</span>, <span class="attr">w</span>: <span class="number">35.5</span>, <span class="attr">uom</span>: <span class="string">&#x27;cm&#x27;</span> &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>【示例】插入多条 document 示例</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="property">inventory</span>.<span class="title function_">insertMany</span>([</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">item</span>: <span class="string">&#x27;journal&#x27;</span>,</span><br><span class="line">    <span class="attr">qty</span>: <span class="number">25</span>,</span><br><span class="line">    <span class="attr">tags</span>: [<span class="string">&#x27;blank&#x27;</span>, <span class="string">&#x27;red&#x27;</span>],</span><br><span class="line">    <span class="attr">size</span>: &#123; <span class="attr">h</span>: <span class="number">14</span>, <span class="attr">w</span>: <span class="number">21</span>, <span class="attr">uom</span>: <span class="string">&#x27;cm&#x27;</span> &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">item</span>: <span class="string">&#x27;mat&#x27;</span>,</span><br><span class="line">    <span class="attr">qty</span>: <span class="number">85</span>,</span><br><span class="line">    <span class="attr">tags</span>: [<span class="string">&#x27;gray&#x27;</span>],</span><br><span class="line">    <span class="attr">size</span>: &#123; <span class="attr">h</span>: <span class="number">27.9</span>, <span class="attr">w</span>: <span class="number">35.5</span>, <span class="attr">uom</span>: <span class="string">&#x27;cm&#x27;</span> &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">item</span>: <span class="string">&#x27;mousepad&#x27;</span>,</span><br><span class="line">    <span class="attr">qty</span>: <span class="number">25</span>,</span><br><span class="line">    <span class="attr">tags</span>: [<span class="string">&#x27;gel&#x27;</span>, <span class="string">&#x27;blue&#x27;</span>],</span><br><span class="line">    <span class="attr">size</span>: &#123; <span class="attr">h</span>: <span class="number">19</span>, <span class="attr">w</span>: <span class="number">22.85</span>, <span class="attr">uom</span>: <span class="string">&#x27;cm&#x27;</span> &#125;</span><br><span class="line">  &#125;</span><br><span class="line">])</span><br></pre></td></tr></table></figure>

<h3 id="Read-操作"><a href="#Read-操作" class="headerlink" title="Read 操作"></a>Read 操作</h3><p>MongoDB 提供 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/method/db.collection.find/#db.collection.find"><code>db.collection.find()</code></a> 方法来检索 document。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/snap/20200924113832.svg" alt="img"></p>
<h3 id="Update-操作"><a href="#Update-操作" class="headerlink" title="Update 操作"></a>Update 操作</h3><p>MongoDB 提供以下操作来更新 collection 中的 document</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/method/db.collection.updateOne/#db.collection.updateOne"><code>db.collection.updateOne()</code></a>：更新一条 document</li>
<li><a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/method/db.collection.updateMany/#db.collection.updateMany"><code>db.collection.updateMany()</code></a>：更新多条 document</li>
<li><a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/method/db.collection.replaceOne/#db.collection.replaceOne"><code>db.collection.replaceOne()</code></a>：替换一条 document</li>
</ul>
<p>语法格式：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/method/db.collection.updateOne/#db.collection.updateOne"><code>db.collection.updateOne(&lt;filter&gt;, &lt;update&gt;, &lt;options&gt;)</code></a></li>
<li><a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/method/db.collection.updateMany/#db.collection.updateMany"><code>db.collection.updateMany(&lt;filter&gt;, &lt;update&gt;, &lt;options&gt;)</code></a></li>
<li><a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/method/db.collection.replaceOne/#db.collection.replaceOne"><code>db.collection.replaceOne(&lt;filter&gt;, &lt;update&gt;, &lt;options&gt;)</code></a></li>
</ul>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/snap/20200924114043.svg" alt="img"></p>
<p>【示例】插入测试数据</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="property">inventory</span>.<span class="title function_">insertMany</span>([</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">item</span>: <span class="string">&#x27;canvas&#x27;</span>,</span><br><span class="line">    <span class="attr">qty</span>: <span class="number">100</span>,</span><br><span class="line">    <span class="attr">size</span>: &#123; <span class="attr">h</span>: <span class="number">28</span>, <span class="attr">w</span>: <span class="number">35.5</span>, <span class="attr">uom</span>: <span class="string">&#x27;cm&#x27;</span> &#125;,</span><br><span class="line">    <span class="attr">status</span>: <span class="string">&#x27;A&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123; <span class="attr">item</span>: <span class="string">&#x27;journal&#x27;</span>, <span class="attr">qty</span>: <span class="number">25</span>, <span class="attr">size</span>: &#123; <span class="attr">h</span>: <span class="number">14</span>, <span class="attr">w</span>: <span class="number">21</span>, <span class="attr">uom</span>: <span class="string">&#x27;cm&#x27;</span> &#125;, <span class="attr">status</span>: <span class="string">&#x27;A&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">item</span>: <span class="string">&#x27;mat&#x27;</span>, <span class="attr">qty</span>: <span class="number">85</span>, <span class="attr">size</span>: &#123; <span class="attr">h</span>: <span class="number">27.9</span>, <span class="attr">w</span>: <span class="number">35.5</span>, <span class="attr">uom</span>: <span class="string">&#x27;cm&#x27;</span> &#125;, <span class="attr">status</span>: <span class="string">&#x27;A&#x27;</span> &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">item</span>: <span class="string">&#x27;mousepad&#x27;</span>,</span><br><span class="line">    <span class="attr">qty</span>: <span class="number">25</span>,</span><br><span class="line">    <span class="attr">size</span>: &#123; <span class="attr">h</span>: <span class="number">19</span>, <span class="attr">w</span>: <span class="number">22.85</span>, <span class="attr">uom</span>: <span class="string">&#x27;cm&#x27;</span> &#125;,</span><br><span class="line">    <span class="attr">status</span>: <span class="string">&#x27;P&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">item</span>: <span class="string">&#x27;notebook&#x27;</span>,</span><br><span class="line">    <span class="attr">qty</span>: <span class="number">50</span>,</span><br><span class="line">    <span class="attr">size</span>: &#123; <span class="attr">h</span>: <span class="number">8.5</span>, <span class="attr">w</span>: <span class="number">11</span>, <span class="attr">uom</span>: <span class="string">&#x27;in&#x27;</span> &#125;,</span><br><span class="line">    <span class="attr">status</span>: <span class="string">&#x27;P&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123; <span class="attr">item</span>: <span class="string">&#x27;paper&#x27;</span>, <span class="attr">qty</span>: <span class="number">100</span>, <span class="attr">size</span>: &#123; <span class="attr">h</span>: <span class="number">8.5</span>, <span class="attr">w</span>: <span class="number">11</span>, <span class="attr">uom</span>: <span class="string">&#x27;in&#x27;</span> &#125;, <span class="attr">status</span>: <span class="string">&#x27;D&#x27;</span> &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">item</span>: <span class="string">&#x27;planner&#x27;</span>,</span><br><span class="line">    <span class="attr">qty</span>: <span class="number">75</span>,</span><br><span class="line">    <span class="attr">size</span>: &#123; <span class="attr">h</span>: <span class="number">22.85</span>, <span class="attr">w</span>: <span class="number">30</span>, <span class="attr">uom</span>: <span class="string">&#x27;cm&#x27;</span> &#125;,</span><br><span class="line">    <span class="attr">status</span>: <span class="string">&#x27;D&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">item</span>: <span class="string">&#x27;postcard&#x27;</span>,</span><br><span class="line">    <span class="attr">qty</span>: <span class="number">45</span>,</span><br><span class="line">    <span class="attr">size</span>: &#123; <span class="attr">h</span>: <span class="number">10</span>, <span class="attr">w</span>: <span class="number">15.25</span>, <span class="attr">uom</span>: <span class="string">&#x27;cm&#x27;</span> &#125;,</span><br><span class="line">    <span class="attr">status</span>: <span class="string">&#x27;A&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">item</span>: <span class="string">&#x27;sketchbook&#x27;</span>,</span><br><span class="line">    <span class="attr">qty</span>: <span class="number">80</span>,</span><br><span class="line">    <span class="attr">size</span>: &#123; <span class="attr">h</span>: <span class="number">14</span>, <span class="attr">w</span>: <span class="number">21</span>, <span class="attr">uom</span>: <span class="string">&#x27;cm&#x27;</span> &#125;,</span><br><span class="line">    <span class="attr">status</span>: <span class="string">&#x27;A&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">item</span>: <span class="string">&#x27;sketch pad&#x27;</span>,</span><br><span class="line">    <span class="attr">qty</span>: <span class="number">95</span>,</span><br><span class="line">    <span class="attr">size</span>: &#123; <span class="attr">h</span>: <span class="number">22.85</span>, <span class="attr">w</span>: <span class="number">30.5</span>, <span class="attr">uom</span>: <span class="string">&#x27;cm&#x27;</span> &#125;,</span><br><span class="line">    <span class="attr">status</span>: <span class="string">&#x27;A&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">])</span><br></pre></td></tr></table></figure>

<p>【示例】更新一条 document</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="property">inventory</span>.<span class="title function_">updateOne</span>(</span><br><span class="line">  &#123; <span class="attr">item</span>: <span class="string">&#x27;paper&#x27;</span> &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">$set</span>: &#123; <span class="string">&#x27;size.uom&#x27;</span>: <span class="string">&#x27;cm&#x27;</span>, <span class="attr">status</span>: <span class="string">&#x27;P&#x27;</span> &#125;,</span><br><span class="line">    <span class="attr">$currentDate</span>: &#123; <span class="attr">lastModified</span>: <span class="literal">true</span> &#125;</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>【示例】更新多条 document</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="property">inventory</span>.<span class="title function_">updateMany</span>(</span><br><span class="line">  &#123; <span class="attr">qty</span>: &#123; <span class="attr">$lt</span>: <span class="number">50</span> &#125; &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">$set</span>: &#123; <span class="string">&#x27;size.uom&#x27;</span>: <span class="string">&#x27;in&#x27;</span>, <span class="attr">status</span>: <span class="string">&#x27;P&#x27;</span> &#125;,</span><br><span class="line">    <span class="attr">$currentDate</span>: &#123; <span class="attr">lastModified</span>: <span class="literal">true</span> &#125;</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>【示例】替换一条 document</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="property">inventory</span>.<span class="title function_">replaceOne</span>(</span><br><span class="line">  &#123; <span class="attr">item</span>: <span class="string">&#x27;paper&#x27;</span> &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">item</span>: <span class="string">&#x27;paper&#x27;</span>,</span><br><span class="line">    <span class="attr">instock</span>: [</span><br><span class="line">      &#123; <span class="attr">warehouse</span>: <span class="string">&#x27;A&#x27;</span>, <span class="attr">qty</span>: <span class="number">60</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">warehouse</span>: <span class="string">&#x27;B&#x27;</span>, <span class="attr">qty</span>: <span class="number">40</span> &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>更新操作的特性：</p>
<ul>
<li>MongoDB 中的所有写操作都是单个文档级别的原子操作。</li>
<li>一旦设置了，就无法更新或替换 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/glossary/#term-id"><code>_id</code></a> 字段。</li>
<li>除以下情况外，MongoDB 会在执行写操作后保留文档字段的顺序：<ul>
<li><code>_id</code> 字段始终是文档中的第一个字段。</li>
<li>包括重命名字段名称的更新可能导致文档中字段的重新排序。</li>
</ul>
</li>
<li>如果更新操作中包含 <code>upsert : true</code> 并且没有 document 匹配过滤器，MongoDB 会新插入一个 document；如果有匹配的 document，MongoDB 会修改或替换这些 document。</li>
</ul>
<h3 id="Delete-操作"><a href="#Delete-操作" class="headerlink" title="Delete 操作"></a>Delete 操作</h3><p>MongoDB 提供以下操作来删除 collection 中的 document</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/method/db.collection.deleteOne/#db.collection.deleteOne"><code>db.collection.deleteOne()</code></a>：删除一条 document</li>
<li><a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/method/db.collection.deleteMany/#db.collection.deleteMany"><code>db.collection.deleteMany()</code></a>：删除多条 document</li>
</ul>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/snap/20200924120007.svg" alt="img"></p>
<p>删除操作的特性：</p>
<ul>
<li>MongoDB 中的所有写操作都是单个文档级别的原子操作。</li>
</ul>
<h2 id="二、批量写操作"><a href="#二、批量写操作" class="headerlink" title="二、批量写操作"></a>二、批量写操作</h2><p>MongoDB 通过 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/method/db.collection.bulkWrite/#db.collection.bulkWrite"><code>db.collection.bulkWrite()</code></a> 方法来支持批量写操作（包括批量插入、更新、删除）。</p>
<p>此外，<a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/method/db.collection.insertMany/#db.collection.insertMany"><code>db.collection.insertMany()</code></a> 方法支持批量插入操作。</p>
<h3 id="有序和无序的操作"><a href="#有序和无序的操作" class="headerlink" title="有序和无序的操作"></a>有序和无序的操作</h3><p>批量写操作可以有序或无序。</p>
<ul>
<li>对于有序列表，MongoDB 串行执行操作。如果在写操作的处理过程中发生错误，MongoDB 将不处理列表中剩余的写操作。</li>
<li>对于无序列表，MongoDB 可以并行执行操作，但是不能保证此行为。如果在写操作的处理过程中发生错误，MongoDB 将继续处理列表中剩余的写操作。</li>
</ul>
<p>在分片集合上执行操作的有序列表通常比执行无序列表要慢，因为对于有序列表，每个操作必须等待上一个操作完成。</p>
<p>默认情况下，<a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/method/db.collection.bulkWrite/#db.collection.bulkWrite"><code>bulkWrite()</code></a> 执行有序操作。要指定无序写操作，请在选项文档中设置 <code>ordered : false</code>。</p>
<h3 id="bulkWrite-方法"><a href="#bulkWrite-方法" class="headerlink" title="bulkWrite() 方法"></a>bulkWrite() 方法</h3><p><a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/method/db.collection.bulkWrite/#db.collection.bulkWrite"><code>bulkWrite()</code></a> 支持以下写操作：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/method/db.collection.bulkWrite/#bulkwrite-write-operations-insertone">insertOne</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/method/db.collection.bulkWrite/#bulkwrite-write-operations-updateonemany">updateOne</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/method/db.collection.bulkWrite/#bulkwrite-write-operations-updateonemany">updateMany</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/method/db.collection.bulkWrite/#bulkwrite-write-operations-replaceone">replaceOne</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/method/db.collection.bulkWrite/#bulkwrite-write-operations-deleteonemany">deleteOne</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/method/db.collection.bulkWrite/#bulkwrite-write-operations-deleteonemany">deleteMany</a></li>
</ul>
<p>【示例】批量写操作示例</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  db.<span class="property">characters</span>.<span class="title function_">bulkWrite</span>([</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">insertOne</span>: &#123;</span><br><span class="line">        <span class="attr">document</span>: &#123;</span><br><span class="line">          <span class="attr">_id</span>: <span class="number">4</span>,</span><br><span class="line">          <span class="attr">char</span>: <span class="string">&#x27;Dithras&#x27;</span>,</span><br><span class="line">          <span class="attr">class</span>: <span class="string">&#x27;barbarian&#x27;</span>,</span><br><span class="line">          <span class="attr">lvl</span>: <span class="number">4</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">insertOne</span>: &#123;</span><br><span class="line">        <span class="attr">document</span>: &#123;</span><br><span class="line">          <span class="attr">_id</span>: <span class="number">5</span>,</span><br><span class="line">          <span class="attr">char</span>: <span class="string">&#x27;Taeln&#x27;</span>,</span><br><span class="line">          <span class="attr">class</span>: <span class="string">&#x27;fighter&#x27;</span>,</span><br><span class="line">          <span class="attr">lvl</span>: <span class="number">3</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">updateOne</span>: &#123;</span><br><span class="line">        <span class="attr">filter</span>: &#123; <span class="attr">char</span>: <span class="string">&#x27;Eldon&#x27;</span> &#125;,</span><br><span class="line">        <span class="attr">update</span>: &#123; <span class="attr">$set</span>: &#123; <span class="attr">status</span>: <span class="string">&#x27;Critical Injury&#x27;</span> &#125; &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123; <span class="attr">deleteOne</span>: &#123; <span class="attr">filter</span>: &#123; <span class="attr">char</span>: <span class="string">&#x27;Brisbane&#x27;</span> &#125; &#125; &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">replaceOne</span>: &#123;</span><br><span class="line">        <span class="attr">filter</span>: &#123; <span class="attr">char</span>: <span class="string">&#x27;Meldane&#x27;</span> &#125;,</span><br><span class="line">        <span class="attr">replacement</span>: &#123; <span class="attr">char</span>: <span class="string">&#x27;Tanys&#x27;</span>, <span class="attr">class</span>: <span class="string">&#x27;oracle&#x27;</span>, <span class="attr">lvl</span>: <span class="number">4</span> &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ])</span><br><span class="line">&#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">  <span class="title function_">print</span>(e)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="批量写操作策略"><a href="#批量写操作策略" class="headerlink" title="批量写操作策略"></a>批量写操作策略</h3><p>大量的插入操作（包括初始数据插入或常规数据导入）可能会影响分片集群的性能。对于批量插入，请考虑以下策略：</p>
<h4 id="预拆分-collection"><a href="#预拆分-collection" class="headerlink" title="预拆分 collection"></a>预拆分 collection</h4><p>如果分片集合为空，则该集合只有一个初始 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/glossary/#term-chunk">chunk</a>，该 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/glossary/#term-chunk">chunk</a> 位于单个分片上。然后，MongoDB 必须花一些时间来接收数据，创建拆分并将拆分的块分发到可用的分片。为了避免这种性能成本，您可以按照拆分群集中的拆分块中的说明预拆分 collection。</p>
<h4 id="无序写操作"><a href="#无序写操作" class="headerlink" title="无序写操作"></a>无序写操作</h4><p>要提高对分片集群的写入性能，请使用 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/method/db.collection.bulkWrite/#db.collection.bulkWrite"><code>bulkWrite()</code></a>，并将可选参数顺序设置为 false。<a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/program/mongos/#bin.mongos"><code>mongos</code></a> 可以尝试同时将写入操作发送到多个分片。对于空集合，首先按照分片群集中的分割 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/glossary/#term-chunk">chunk</a> 中的说明预拆分 collection。</p>
<h4 id="避免单调节流"><a href="#避免单调节流" class="headerlink" title="避免单调节流"></a>避免单调节流</h4><p>如果在一次插入操作中，分片 key 单调递增，那么所有的插入数据都会存入 collection 的最后一个 chunk，也就是存入一个分片中。因此，集群的插入容量将永远不会超过该单个分片的插入容量。</p>
<p>如果插入量大于单个分片可以处理的插入量，并且无法避免单调递增的分片键，那么请考虑对应用程序进行以下修改：</p>
<ul>
<li>反转分片密钥的二进制位。这样可以保留信息，并避免将插入顺序与值序列的增加关联起来。</li>
<li>交换第一个和最后一个 16 位字以“随机”插入。</li>
</ul>
<h2 id="SQL-和-MongoDB-对比"><a href="#SQL-和-MongoDB-对比" class="headerlink" title="SQL 和 MongoDB 对比"></a>SQL 和 MongoDB 对比</h2><h3 id="术语和概念"><a href="#术语和概念" class="headerlink" title="术语和概念"></a>术语和概念</h3><table>
<thead>
<tr>
<th align="left">SQL 术语和概念</th>
<th align="left">MongoDB 术语和概念</th>
</tr>
</thead>
<tbody><tr>
<td align="left">database</td>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/glossary/#term-database">database</a></td>
</tr>
<tr>
<td align="left">table</td>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/glossary/#term-collection">collection</a></td>
</tr>
<tr>
<td align="left">row</td>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/glossary/#term-document">document</a> 或 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/glossary/#term-bson">BSON</a></td>
</tr>
<tr>
<td align="left">column</td>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/glossary/#term-field">field</a></td>
</tr>
<tr>
<td align="left">index</td>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/glossary/#term-index">index</a></td>
</tr>
<tr>
<td align="left">table joins</td>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/operator/aggregation/lookup/#pipe._S_lookup"><code>$lookup</code></a>、嵌入式文档</td>
</tr>
<tr>
<td align="left">primary key</td>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/glossary/#term-primary-key">primary key</a><br>MongoDB 中自动设置主键为 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/glossary/#term-id"><code>_id</code></a> 字段</td>
</tr>
<tr>
<td align="left">aggregation (e.g. group by)</td>
<td align="left">aggregation pipeline<br>参考 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/sql-aggregation-comparison/">SQL to Aggregation Mapping Chart</a>.</td>
</tr>
<tr>
<td align="left">SELECT INTO NEW_TABLE</td>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/operator/aggregation/out/#pipe._S_out"><code>$out</code></a><br>参考 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/sql-aggregation-comparison/">SQL to Aggregation Mapping Chart</a></td>
</tr>
<tr>
<td align="left">MERGE INTO TABLE</td>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/operator/aggregation/merge/#pipe._S_merge"><code>$merge</code></a> (MongoDB 4.2 开始支持)<br>参考 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/sql-aggregation-comparison/">SQL to Aggregation Mapping Chart</a>.</td>
</tr>
<tr>
<td align="left">UNION ALL</td>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/operator/aggregation/unionWith/#pipe._S_unionWith"><code>$unionWith</code></a> (MongoDB 4.4 开始支持)</td>
</tr>
<tr>
<td align="left">transactions</td>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/core/transactions/">transactions</a></td>
</tr>
</tbody></table>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><strong>官方</strong><ul>
<li><a target="_blank" rel="noopener" href="https://www.mongodb.com/">MongoDB 官网</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/mongodb/mongo">MongoDB Github</a></li>
<li><a target="_blank" rel="noopener" href="https://university.mongodb.com/">MongoDB 官方免费教程</a></li>
</ul>
</li>
<li><strong>教程</strong><ul>
<li><a target="_blank" rel="noopener" href="https://www.runoob.com/mongodb/mongodb-tutorial.html">MongoDB 教程</a></li>
<li><a target="_blank" rel="noopener" href="https://time.geekbang.org/course/intro/100040001">MongoDB 高手课</a></li>
</ul>
</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/pages/75daa5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/avatar.gif">
      <meta itemprop="name" content="钝悟 ◾ Dunwu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu Blog">
      <meta itemprop="description" content="钝悟的个人博客">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Dunwu Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/pages/75daa5/" class="post-title-link" itemprop="url">MongoDB 的聚合操作</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-09-21 21:22:57" itemprop="dateCreated datePublished" datetime="2020-09-21T21:22:57+08:00">2020-09-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-09-23 18:54:25" itemprop="dateModified" datetime="2022-09-23T18:54:25+08:00">2022-09-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">数据库</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/%E6%96%87%E6%A1%A3%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">文档数据库</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/%E6%96%87%E6%A1%A3%E6%95%B0%E6%8D%AE%E5%BA%93/MongoDB/" itemprop="url" rel="index"><span itemprop="name">MongoDB</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>7.4k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>7 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="MongoDB-的聚合操作"><a href="#MongoDB-的聚合操作" class="headerlink" title="MongoDB 的聚合操作"></a>MongoDB 的聚合操作</h1><p>聚合操作处理数据记录并返回计算结果。聚合操作将来自多个 document 的值分组，并可以对分组的数据执行各种操作以返回单个结果。 MongoDB 提供了三种执行聚合的方式：聚合管道，map-reduce 函数和单一目的聚合方法。</p>
<h2 id="Pipeline"><a href="#Pipeline" class="headerlink" title="Pipeline"></a>Pipeline</h2><h3 id="Pipeline-简介"><a href="#Pipeline-简介" class="headerlink" title="Pipeline 简介"></a>Pipeline 简介</h3><p>MongoDB 的聚合框架以数据处理管道（Pipeline）的概念为模型。</p>
<p><strong>MongoDB 通过 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/method/db.collection.aggregate/#db.collection.aggregate"><code>db.collection.aggregate()</code></a> 方法支持聚合操作</strong>。并提供了 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/command/aggregate/#dbcmd.aggregate"><code>aggregate</code></a> 命令来执行 pipeline。</p>
<p>MongoDB Pipeline 由多个阶段（<a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/operator/aggregation-pipeline/#aggregation-pipeline-operator-reference">stages</a>）组成。每个阶段在 document 通过 pipeline 时都会对其进行转换。pipeline 阶段不需要为每个输入 document 都生成一个输出 document。例如，某些阶段可能会生成新 document 或过滤 document。</p>
<p>同一个阶段可以在 pipeline 中出现多次，但 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/operator/aggregation/out/#pipe._S_out"><code>$out</code></a>、<a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/operator/aggregation/merge/#pipe._S_merge"><code>$merge</code></a>,和 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/operator/aggregation/geoNear/#pipe._S_geoNear"><code>$geoNear</code></a> 阶段除外。所有可用 pipeline 阶段可以参考：<a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/operator/aggregation-pipeline/#aggregation-pipeline-operator-reference">Aggregation Pipeline Stages</a>。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/snap/20200921092725.png" alt="img"></p>
<ul>
<li>第一阶段：<a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/operator/aggregation/match/#pipe._S_match"><code>$match</code></a> 阶段按状态字段过滤 document，然后将状态等于“ A”的那些 document 传递到下一阶段。</li>
<li>第二阶段：<a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/operator/aggregation/group/#pipe._S_group"><code>$group</code></a> 阶段按 cust_id 字段对 document 进行分组，以计算每个唯一 cust_id 的金额总和。</li>
</ul>
<p>最基本的管道阶段提供过滤器，其操作类似于查询和 document 转换（修改输出 document 形式）。</p>
<p>其他管道操作提供了用于按特定字段对 document 进行分组和排序的工具，以及用于汇总数组（包括 document 数组）内容的工具。另外，管道阶段可以将运算符用于诸如计算平均值或连接字符串之类的任务。</p>
<p>聚合管道也可以在分片 collection 上操作。</p>
<h3 id="Pipeline-优化"><a href="#Pipeline-优化" class="headerlink" title="Pipeline 优化"></a>Pipeline 优化</h3><h4 id="投影优化"><a href="#投影优化" class="headerlink" title="投影优化"></a>投影优化</h4><p>Pipeline 可以确定是否仅需要 document 中必填字段即可获得结果。</p>
<h4 id="Pipeline-串行优化"><a href="#Pipeline-串行优化" class="headerlink" title="Pipeline 串行优化"></a>Pipeline 串行优化</h4><p>（<code>$project</code>、<code>$unset</code>、<code>$addFields</code>、<code>$set</code>） + <code>$match</code> 串行优化</p>
<p>对于包含投影阶段（<a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/operator/aggregation/project/#pipe._S_project"><code>$project</code></a> 或 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/operator/aggregation/unset/#pipe._S_unset"><code>$unset</code></a> 或 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/operator/aggregation/addFields/#pipe._S_addFields"><code>$addFields</code></a> 或 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/operator/aggregation/set/#pipe._S_set"><code>$set</code></a>），且后续跟随着 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/operator/aggregation/match/#pipe._S_match"><code>$match</code></a> 阶段的 Pipeline ，MongoDB 会将所有 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/operator/aggregation/match/#pipe._S_match"><code>$match</code></a> 阶段中不需要在投影阶段中计算出的值的过滤器，移动一个在投影阶段之前的新 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/operator/aggregation/match/#pipe._S_match"><code>$match</code></a> 阶段。</p>
<p>如果 Pipeline 包含多个投影阶段 和 &#x2F; 或 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/operator/aggregation/match/#pipe._S_match"><code>$match</code></a> 阶段，则 MongoDB 将为每个 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/operator/aggregation/match/#pipe._S_match"><code>$match</code></a> 阶段执行此优化，将每个 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/operator/aggregation/match/#pipe._S_match"><code>$match</code></a> 过滤器移动到该过滤器不依赖的所有投影阶段之前。</p>
<p>【示例】Pipeline 串行优化示例</p>
<p>优化前：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123; <span class="attr">$addFields</span>: &#123;</span><br><span class="line">    <span class="attr">maxTime</span>: &#123; <span class="attr">$max</span>: <span class="string">&quot;$times&quot;</span> &#125;,</span><br><span class="line">    <span class="attr">minTime</span>: &#123; <span class="attr">$min</span>: <span class="string">&quot;$times&quot;</span> &#125;</span><br><span class="line">&#125; &#125;,</span><br><span class="line">&#123; <span class="attr">$project</span>: &#123;</span><br><span class="line">    <span class="attr">_id</span>: <span class="number">1</span>, <span class="attr">name</span>: <span class="number">1</span>, <span class="attr">times</span>: <span class="number">1</span>, <span class="attr">maxTime</span>: <span class="number">1</span>, <span class="attr">minTime</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">avgTime</span>: &#123; <span class="attr">$avg</span>: [<span class="string">&quot;$maxTime&quot;</span>, <span class="string">&quot;$minTime&quot;</span>] &#125;</span><br><span class="line">&#125; &#125;,</span><br><span class="line">&#123; <span class="attr">$match</span>: &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&quot;Joe Schmoe&quot;</span>,</span><br><span class="line">    <span class="attr">maxTime</span>: &#123; <span class="attr">$lt</span>: <span class="number">20</span> &#125;,</span><br><span class="line">    <span class="attr">minTime</span>: &#123; <span class="attr">$gt</span>: <span class="number">5</span> &#125;,</span><br><span class="line">    <span class="attr">avgTime</span>: &#123; <span class="attr">$gt</span>: <span class="number">7</span> &#125;</span><br><span class="line">&#125; &#125;</span><br></pre></td></tr></table></figure>

<p>优化后：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123; <span class="attr">$match</span>: &#123; <span class="attr">name</span>: <span class="string">&quot;Joe Schmoe&quot;</span> &#125; &#125;,</span><br><span class="line">&#123; <span class="attr">$addFields</span>: &#123;</span><br><span class="line">    <span class="attr">maxTime</span>: &#123; <span class="attr">$max</span>: <span class="string">&quot;$times&quot;</span> &#125;,</span><br><span class="line">    <span class="attr">minTime</span>: &#123; <span class="attr">$min</span>: <span class="string">&quot;$times&quot;</span> &#125;</span><br><span class="line">&#125; &#125;,</span><br><span class="line">&#123; <span class="attr">$match</span>: &#123; <span class="attr">maxTime</span>: &#123; <span class="attr">$lt</span>: <span class="number">20</span> &#125;, <span class="attr">minTime</span>: &#123; <span class="attr">$gt</span>: <span class="number">5</span> &#125; &#125; &#125;,</span><br><span class="line">&#123; <span class="attr">$project</span>: &#123;</span><br><span class="line">    <span class="attr">_id</span>: <span class="number">1</span>, <span class="attr">name</span>: <span class="number">1</span>, <span class="attr">times</span>: <span class="number">1</span>, <span class="attr">maxTime</span>: <span class="number">1</span>, <span class="attr">minTime</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">avgTime</span>: &#123; <span class="attr">$avg</span>: [<span class="string">&quot;$maxTime&quot;</span>, <span class="string">&quot;$minTime&quot;</span>] &#125;</span><br><span class="line">&#125; &#125;,</span><br><span class="line">&#123; <span class="attr">$match</span>: &#123; <span class="attr">avgTime</span>: &#123; <span class="attr">$gt</span>: <span class="number">7</span> &#125; &#125; &#125;</span><br></pre></td></tr></table></figure>

<p>说明：</p>
<p><code>&#123; name: &quot;Joe Schmoe&quot; &#125;</code> 不需要计算任何投影阶段的值，所以可以放在最前面。</p>
<p><code>&#123; avgTime: &#123; $gt: 7 &#125; &#125;</code> 依赖 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/operator/aggregation/project/#pipe._S_project"><code>$project</code></a> 阶段的 <code>avgTime</code> 字段，所以不能移动。</p>
<p><code>maxTime</code> 和 <code>minTime</code> 字段被 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/operator/aggregation/addFields/#pipe._S_addFields"><code>$addFields</code></a> 阶段所依赖，但自身不依赖其他，所以会新建一个 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/operator/aggregation/match/#pipe._S_match"><code>$match</code></a> 阶段，并将其置于 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/operator/aggregation/project/#pipe._S_project"><code>$project</code></a> 阶段之前。</p>
<h4 id="Pipeline-并行优化"><a href="#Pipeline-并行优化" class="headerlink" title="Pipeline 并行优化"></a>Pipeline 并行优化</h4><p>如果可能，优化阶段会将 Pipeline 阶段合并到其前身。通常，合并发生在任意序列重新排序优化之后。</p>
<h5 id="sort-limit"><a href="#sort-limit" class="headerlink" title="$sort + $limit"></a><code>$sort</code> + <code>$limit</code></h5><p>当 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/operator/aggregation/sort/#pipe._S_sort"><code>$sort</code></a> 在 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/operator/aggregation/limit/#pipe._S_limit"><code>$limit</code></a> 之前时，如果没有中间阶段修改文档数量（例如 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/operator/aggregation/unwind/#pipe._S_unwind"><code>$unwind</code></a>、<a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/operator/aggregation/group/#pipe._S_group"><code>$group</code></a>），则优化程序可以将 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/operator/aggregation/limit/#pipe._S_limit"><code>$limit</code></a> 合并到 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/operator/aggregation/sort/#pipe._S_sort"><code>$sort</code></a> 中。如果有管道阶段更改了 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/operator/aggregation/sort/#pipe._S_sort"><code>$sort</code></a> 和 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/operator/aggregation/limit/#pipe._S_limit"><code>$limit</code></a> 阶段之间的文档数，则 MongoDB 不会将 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/operator/aggregation/limit/#pipe._S_limit"><code>$limit</code></a> 合并到 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/operator/aggregation/sort/#pipe._S_sort"><code>$sort</code></a> 中。</p>
<p>【示例】<code>$sort</code> + <code>$limit</code></p>
<p>优化前：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123; $sort : &#123; age : -<span class="number">1</span> &#125; &#125;,</span><br><span class="line">&#123; $project : &#123; age : <span class="number">1</span>, status : <span class="number">1</span>, name : <span class="number">1</span> &#125; &#125;,</span><br><span class="line">&#123; <span class="attr">$limit</span>: <span class="number">5</span> &#125;</span><br></pre></td></tr></table></figure>

<p>优化后：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;$sort&quot;</span> : &#123;</span><br><span class="line">       <span class="string">&quot;sortKey&quot;</span> : &#123;</span><br><span class="line">          <span class="string">&quot;age&quot;</span> : -<span class="number">1</span></span><br><span class="line">       &#125;,</span><br><span class="line">       <span class="string">&quot;limit&quot;</span> : <span class="title class_">NumberLong</span>(<span class="number">5</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;,</span><br><span class="line">&#123; <span class="string">&quot;$project&quot;</span> : &#123;</span><br><span class="line">         <span class="string">&quot;age&quot;</span> : <span class="number">1</span>,</span><br><span class="line">         <span class="string">&quot;status&quot;</span> : <span class="number">1</span>,</span><br><span class="line">         <span class="string">&quot;name&quot;</span> : <span class="number">1</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="limit-limit"><a href="#limit-limit" class="headerlink" title="$limit + $limit"></a><code>$limit</code> + <code>$limit</code></h5><p>如果一个 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/operator/aggregation/limit/#pipe._S_limit"><code>$limit</code></a> 紧随另一个 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/operator/aggregation/limit/#pipe._S_limit"><code>$limit</code></a>，那么它们可以合并为一。</p>
<p>优化前：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123; <span class="attr">$limit</span>: <span class="number">100</span> &#125;,</span><br><span class="line">&#123; <span class="attr">$limit</span>: <span class="number">10</span> &#125;</span><br></pre></td></tr></table></figure>

<p>优化后：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">$limit</span>: <span class="number">10</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="skip-skip"><a href="#skip-skip" class="headerlink" title="$skip + $skip"></a><code>$skip</code> + <code>$skip</code></h5><p>如果一个 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/operator/aggregation/skip/#pipe._S_skip"><code>$skip</code></a> 紧随另一个 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/operator/aggregation/skip/#pipe._S_skip"><code>$skip</code></a> ，那么它们可以合并为一。</p>
<p>优化前：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123; <span class="attr">$skip</span>: <span class="number">5</span> &#125;,</span><br><span class="line">&#123; <span class="attr">$skip</span>: <span class="number">2</span> &#125;</span><br></pre></td></tr></table></figure>

<p>优化后：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">$skip</span>: <span class="number">7</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="match-match"><a href="#match-match" class="headerlink" title="$match + $match"></a><code>$match</code> + <code>$match</code></h5><p>如果一个 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/operator/aggregation/skip/#pipe._S_skip"><code>$skip</code></a> 紧随另一个 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/operator/aggregation/skip/#pipe._S_skip"><code>$skip</code></a> ，那么它们可以通过 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/operator/aggregation/and/#exp._S_and"><code>$and</code></a> 合并为一。</p>
<p>优化前：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123; <span class="attr">$match</span>: &#123; <span class="attr">year</span>: <span class="number">2014</span> &#125; &#125;,</span><br><span class="line">&#123; <span class="attr">$match</span>: &#123; <span class="attr">status</span>: <span class="string">&quot;A&quot;</span> &#125; &#125;</span><br></pre></td></tr></table></figure>

<p>优化后：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">$match</span>: &#123;</span><br><span class="line">    <span class="attr">$and</span>: [&#123; <span class="attr">year</span>: <span class="number">2014</span> &#125;, &#123; <span class="attr">status</span>: <span class="string">&#x27;A&#x27;</span> &#125;]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="lookup-unwind"><a href="#lookup-unwind" class="headerlink" title="$lookup + $unwind"></a><code>$lookup</code> + <code>$unwind</code></h5><p>如果一个 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/operator/aggregation/unwind/#pipe._S_unwind"><code>$unwind</code></a> 紧随另一个 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/operator/aggregation/lookup/#pipe._S_lookup"><code>$lookup</code></a>，并且 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/operator/aggregation/unwind/#pipe._S_unwind"><code>$unwind</code></a> 在 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/operator/aggregation/lookup/#pipe._S_lookup"><code>$lookup</code></a> 的 as 字段上运行时，优化程序可以将 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/operator/aggregation/unwind/#pipe._S_unwind"><code>$unwind</code></a> 合并到 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/operator/aggregation/lookup/#pipe._S_lookup"><code>$lookup</code></a> 阶段。这样可以避免创建较大的中间文档。</p>
<p>优化前：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">$lookup</span>: &#123;</span><br><span class="line">    <span class="attr">from</span>: <span class="string">&quot;otherCollection&quot;</span>,</span><br><span class="line">    <span class="attr">as</span>: <span class="string">&quot;resultingArray&quot;</span>,</span><br><span class="line">    <span class="attr">localField</span>: <span class="string">&quot;x&quot;</span>,</span><br><span class="line">    <span class="attr">foreignField</span>: <span class="string">&quot;y&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;,</span><br><span class="line">&#123; <span class="attr">$unwind</span>: <span class="string">&quot;$resultingArray&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<p>优化后：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">$lookup</span>: &#123;</span><br><span class="line">    <span class="attr">from</span>: <span class="string">&quot;otherCollection&quot;</span>,</span><br><span class="line">    <span class="attr">as</span>: <span class="string">&quot;resultingArray&quot;</span>,</span><br><span class="line">    <span class="attr">localField</span>: <span class="string">&quot;x&quot;</span>,</span><br><span class="line">    <span class="attr">foreignField</span>: <span class="string">&quot;y&quot;</span>,</span><br><span class="line">    <span class="attr">unwinding</span>: &#123; <span class="attr">preserveNullAndEmptyArrays</span>: <span class="literal">false</span> &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Pipeline-限制"><a href="#Pipeline-限制" class="headerlink" title="Pipeline 限制"></a>Pipeline 限制</h3><p>结果集中的每个文档均受 BSON 文档大小限制（当前为 16 MB）</p>
<p>Pipeline 的内存限制为 100 MB。</p>
<h2 id="Map-Reduce"><a href="#Map-Reduce" class="headerlink" title="Map-Reduce"></a>Map-Reduce</h2><blockquote>
<p>聚合 pipeline 比 map-reduce 提供更好的性能和更一致的接口。</p>
</blockquote>
<p>Map-reduce 是一种数据处理范式，用于将大量数据汇总为有用的聚合结果。为了执行 map-reduce 操作，MongoDB 提供了 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/command/mapReduce/#dbcmd.mapReduce"><code>mapReduce</code></a> 数据库命令。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/snap/20200921155546.svg" alt="img"></p>
<p>在上面的操作中，MongoDB 将 map 阶段应用于每个输入 document（即 collection 中与查询条件匹配的 document）。 map 函数分发出多个键-值对。对于具有多个值的那些键，MongoDB 应用 reduce 阶段，该阶段收集并汇总聚合的数据。然后，MongoDB 将结果存储在 collection 中。可选地，reduce 函数的输出可以通过 finalize 函数来进一步汇总聚合结果。</p>
<p>MongoDB 中的所有 map-reduce 函数都是 JavaScript，并在 mongod 进程中运行。 Map-reduce 操作将单个 collection 的 document 作为输入，并且可以在开始 map 阶段之前执行任意排序和限制。 mapReduce 可以将 map-reduce 操作的结果作为 document 返回，也可以将结果写入 collection。</p>
<h2 id="单一目的聚合方法"><a href="#单一目的聚合方法" class="headerlink" title="单一目的聚合方法"></a>单一目的聚合方法</h2><p>MongoDB 支持一下单一目的的聚合操作：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/method/db.collection.estimatedDocumentCount/#db.collection.estimatedDocumentCount"><code>db.collection.estimatedDocumentCount()</code></a></li>
<li><a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/method/db.collection.count/#db.collection.count"><code>db.collection.count()</code></a></li>
<li><a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/method/db.collection.distinct/#db.collection.distinct"><code>db.collection.distinct()</code></a></li>
</ul>
<p>所有这些操作都汇总了单个 collection 中的 document。尽管这些操作提供了对常见聚合过程的简单访问，但是它们相比聚合 pipeline 和 map-reduce，缺少灵活性和丰富的功能性。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/snap/20200921155935.svg" alt="img"></p>
<h2 id="SQL-和-MongoDB-聚合对比"><a href="#SQL-和-MongoDB-聚合对比" class="headerlink" title="SQL 和 MongoDB 聚合对比"></a>SQL 和 MongoDB 聚合对比</h2><p>MongoDB pipeline 提供了许多等价于 SQL 中常见聚合语句的操作。</p>
<p>下表概述了常见的 SQL 聚合语句或函数和 MongoDB 聚合操作的映射表：</p>
<table>
<thead>
<tr>
<th align="left">SQL Terms, Functions, and Concepts</th>
<th align="left">MongoDB Aggregation Operators</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><code>WHERE</code></td>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/operator/aggregation/match/#pipe._S_match"><code>$match</code></a></td>
</tr>
<tr>
<td align="left"><code>GROUP BY</code></td>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/operator/aggregation/group/#pipe._S_group"><code>$group</code></a></td>
</tr>
<tr>
<td align="left"><code>HAVING</code></td>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/operator/aggregation/match/#pipe._S_match"><code>$match</code></a></td>
</tr>
<tr>
<td align="left"><code>SELECT</code></td>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/operator/aggregation/project/#pipe._S_project"><code>$project</code></a></td>
</tr>
<tr>
<td align="left"><code>ORDER BY</code></td>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/operator/aggregation/sort/#pipe._S_sort"><code>$sort</code></a></td>
</tr>
<tr>
<td align="left"><code>LIMIT</code></td>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/operator/aggregation/limit/#pipe._S_limit"><code>$limit</code></a></td>
</tr>
<tr>
<td align="left"><code>SUM()</code></td>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/operator/aggregation/sum/#grp._S_sum"><code>$sum</code></a></td>
</tr>
<tr>
<td align="left"><code>COUNT()</code></td>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/operator/aggregation/sum/#grp._S_sum"><code>$sum</code></a><a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/operator/aggregation/sortByCount/#pipe._S_sortByCount"><code>$sortByCount</code></a></td>
</tr>
<tr>
<td align="left"><code>JOIN</code></td>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/operator/aggregation/lookup/#pipe._S_lookup"><code>$lookup</code></a></td>
</tr>
<tr>
<td align="left"><code>SELECT INTO NEW_TABLE</code></td>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/operator/aggregation/out/#pipe._S_out"><code>$out</code></a></td>
</tr>
<tr>
<td align="left"><code>MERGE INTO TABLE</code></td>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/operator/aggregation/merge/#pipe._S_merge"><code>$merge</code></a> (Available starting in MongoDB 4.2)</td>
</tr>
<tr>
<td align="left"><code>UNION ALL</code></td>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/operator/aggregation/unionWith/#pipe._S_unionWith"><code>$unionWith</code></a> (Available starting in MongoDB 4.4)</td>
</tr>
</tbody></table>
<p>【示例】</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="property">orders</span>.<span class="title function_">insertMany</span>([</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">_id</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">cust_id</span>: <span class="string">&#x27;Ant O. Knee&#x27;</span>,</span><br><span class="line">    <span class="attr">ord_date</span>: <span class="keyword">new</span> <span class="title class_">Date</span>(<span class="string">&#x27;2020-03-01&#x27;</span>),</span><br><span class="line">    <span class="attr">price</span>: <span class="number">25</span>,</span><br><span class="line">    <span class="attr">items</span>: [</span><br><span class="line">      &#123; <span class="attr">sku</span>: <span class="string">&#x27;oranges&#x27;</span>, <span class="attr">qty</span>: <span class="number">5</span>, <span class="attr">price</span>: <span class="number">2.5</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">sku</span>: <span class="string">&#x27;apples&#x27;</span>, <span class="attr">qty</span>: <span class="number">5</span>, <span class="attr">price</span>: <span class="number">2.5</span> &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">status</span>: <span class="string">&#x27;A&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">_id</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="attr">cust_id</span>: <span class="string">&#x27;Ant O. Knee&#x27;</span>,</span><br><span class="line">    <span class="attr">ord_date</span>: <span class="keyword">new</span> <span class="title class_">Date</span>(<span class="string">&#x27;2020-03-08&#x27;</span>),</span><br><span class="line">    <span class="attr">price</span>: <span class="number">70</span>,</span><br><span class="line">    <span class="attr">items</span>: [</span><br><span class="line">      &#123; <span class="attr">sku</span>: <span class="string">&#x27;oranges&#x27;</span>, <span class="attr">qty</span>: <span class="number">8</span>, <span class="attr">price</span>: <span class="number">2.5</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">sku</span>: <span class="string">&#x27;chocolates&#x27;</span>, <span class="attr">qty</span>: <span class="number">5</span>, <span class="attr">price</span>: <span class="number">10</span> &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">status</span>: <span class="string">&#x27;A&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">_id</span>: <span class="number">3</span>,</span><br><span class="line">    <span class="attr">cust_id</span>: <span class="string">&#x27;Busby Bee&#x27;</span>,</span><br><span class="line">    <span class="attr">ord_date</span>: <span class="keyword">new</span> <span class="title class_">Date</span>(<span class="string">&#x27;2020-03-08&#x27;</span>),</span><br><span class="line">    <span class="attr">price</span>: <span class="number">50</span>,</span><br><span class="line">    <span class="attr">items</span>: [</span><br><span class="line">      &#123; <span class="attr">sku</span>: <span class="string">&#x27;oranges&#x27;</span>, <span class="attr">qty</span>: <span class="number">10</span>, <span class="attr">price</span>: <span class="number">2.5</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">sku</span>: <span class="string">&#x27;pears&#x27;</span>, <span class="attr">qty</span>: <span class="number">10</span>, <span class="attr">price</span>: <span class="number">2.5</span> &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">status</span>: <span class="string">&#x27;A&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">_id</span>: <span class="number">4</span>,</span><br><span class="line">    <span class="attr">cust_id</span>: <span class="string">&#x27;Busby Bee&#x27;</span>,</span><br><span class="line">    <span class="attr">ord_date</span>: <span class="keyword">new</span> <span class="title class_">Date</span>(<span class="string">&#x27;2020-03-18&#x27;</span>),</span><br><span class="line">    <span class="attr">price</span>: <span class="number">25</span>,</span><br><span class="line">    <span class="attr">items</span>: [&#123; <span class="attr">sku</span>: <span class="string">&#x27;oranges&#x27;</span>, <span class="attr">qty</span>: <span class="number">10</span>, <span class="attr">price</span>: <span class="number">2.5</span> &#125;],</span><br><span class="line">    <span class="attr">status</span>: <span class="string">&#x27;A&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">_id</span>: <span class="number">5</span>,</span><br><span class="line">    <span class="attr">cust_id</span>: <span class="string">&#x27;Busby Bee&#x27;</span>,</span><br><span class="line">    <span class="attr">ord_date</span>: <span class="keyword">new</span> <span class="title class_">Date</span>(<span class="string">&#x27;2020-03-19&#x27;</span>),</span><br><span class="line">    <span class="attr">price</span>: <span class="number">50</span>,</span><br><span class="line">    <span class="attr">items</span>: [&#123; <span class="attr">sku</span>: <span class="string">&#x27;chocolates&#x27;</span>, <span class="attr">qty</span>: <span class="number">5</span>, <span class="attr">price</span>: <span class="number">10</span> &#125;],</span><br><span class="line">    <span class="attr">status</span>: <span class="string">&#x27;A&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">_id</span>: <span class="number">6</span>,</span><br><span class="line">    <span class="attr">cust_id</span>: <span class="string">&#x27;Cam Elot&#x27;</span>,</span><br><span class="line">    <span class="attr">ord_date</span>: <span class="keyword">new</span> <span class="title class_">Date</span>(<span class="string">&#x27;2020-03-19&#x27;</span>),</span><br><span class="line">    <span class="attr">price</span>: <span class="number">35</span>,</span><br><span class="line">    <span class="attr">items</span>: [</span><br><span class="line">      &#123; <span class="attr">sku</span>: <span class="string">&#x27;carrots&#x27;</span>, <span class="attr">qty</span>: <span class="number">10</span>, <span class="attr">price</span>: <span class="number">1.0</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">sku</span>: <span class="string">&#x27;apples&#x27;</span>, <span class="attr">qty</span>: <span class="number">10</span>, <span class="attr">price</span>: <span class="number">2.5</span> &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">status</span>: <span class="string">&#x27;A&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">_id</span>: <span class="number">7</span>,</span><br><span class="line">    <span class="attr">cust_id</span>: <span class="string">&#x27;Cam Elot&#x27;</span>,</span><br><span class="line">    <span class="attr">ord_date</span>: <span class="keyword">new</span> <span class="title class_">Date</span>(<span class="string">&#x27;2020-03-20&#x27;</span>),</span><br><span class="line">    <span class="attr">price</span>: <span class="number">25</span>,</span><br><span class="line">    <span class="attr">items</span>: [&#123; <span class="attr">sku</span>: <span class="string">&#x27;oranges&#x27;</span>, <span class="attr">qty</span>: <span class="number">10</span>, <span class="attr">price</span>: <span class="number">2.5</span> &#125;],</span><br><span class="line">    <span class="attr">status</span>: <span class="string">&#x27;A&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">_id</span>: <span class="number">8</span>,</span><br><span class="line">    <span class="attr">cust_id</span>: <span class="string">&#x27;Don Quis&#x27;</span>,</span><br><span class="line">    <span class="attr">ord_date</span>: <span class="keyword">new</span> <span class="title class_">Date</span>(<span class="string">&#x27;2020-03-20&#x27;</span>),</span><br><span class="line">    <span class="attr">price</span>: <span class="number">75</span>,</span><br><span class="line">    <span class="attr">items</span>: [</span><br><span class="line">      &#123; <span class="attr">sku</span>: <span class="string">&#x27;chocolates&#x27;</span>, <span class="attr">qty</span>: <span class="number">5</span>, <span class="attr">price</span>: <span class="number">10</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">sku</span>: <span class="string">&#x27;apples&#x27;</span>, <span class="attr">qty</span>: <span class="number">10</span>, <span class="attr">price</span>: <span class="number">2.5</span> &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">status</span>: <span class="string">&#x27;A&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">_id</span>: <span class="number">9</span>,</span><br><span class="line">    <span class="attr">cust_id</span>: <span class="string">&#x27;Don Quis&#x27;</span>,</span><br><span class="line">    <span class="attr">ord_date</span>: <span class="keyword">new</span> <span class="title class_">Date</span>(<span class="string">&#x27;2020-03-20&#x27;</span>),</span><br><span class="line">    <span class="attr">price</span>: <span class="number">55</span>,</span><br><span class="line">    <span class="attr">items</span>: [</span><br><span class="line">      &#123; <span class="attr">sku</span>: <span class="string">&#x27;carrots&#x27;</span>, <span class="attr">qty</span>: <span class="number">5</span>, <span class="attr">price</span>: <span class="number">1.0</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">sku</span>: <span class="string">&#x27;apples&#x27;</span>, <span class="attr">qty</span>: <span class="number">10</span>, <span class="attr">price</span>: <span class="number">2.5</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">sku</span>: <span class="string">&#x27;oranges&#x27;</span>, <span class="attr">qty</span>: <span class="number">10</span>, <span class="attr">price</span>: <span class="number">2.5</span> &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">status</span>: <span class="string">&#x27;A&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">_id</span>: <span class="number">10</span>,</span><br><span class="line">    <span class="attr">cust_id</span>: <span class="string">&#x27;Don Quis&#x27;</span>,</span><br><span class="line">    <span class="attr">ord_date</span>: <span class="keyword">new</span> <span class="title class_">Date</span>(<span class="string">&#x27;2020-03-23&#x27;</span>),</span><br><span class="line">    <span class="attr">price</span>: <span class="number">25</span>,</span><br><span class="line">    <span class="attr">items</span>: [&#123; <span class="attr">sku</span>: <span class="string">&#x27;oranges&#x27;</span>, <span class="attr">qty</span>: <span class="number">10</span>, <span class="attr">price</span>: <span class="number">2.5</span> &#125;],</span><br><span class="line">    <span class="attr">status</span>: <span class="string">&#x27;A&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">])</span><br></pre></td></tr></table></figure>

<p>SQL 和 MongoDB 聚合方式对比：</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/snap/20200921200556.png" alt="img"></p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><strong>官方</strong><ul>
<li><a target="_blank" rel="noopener" href="https://www.mongodb.com/">MongoDB 官网</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/mongodb/mongo">MongoDB Github</a></li>
<li><a target="_blank" rel="noopener" href="https://university.mongodb.com/">MongoDB 官方免费教程</a></li>
</ul>
</li>
<li><strong>教程</strong><ul>
<li><a target="_blank" rel="noopener" href="https://www.runoob.com/mongodb/mongodb-tutorial.html">MongoDB 教程</a></li>
<li><a target="_blank" rel="noopener" href="https://time.geekbang.org/course/intro/100040001">MongoDB 高手课</a></li>
</ul>
</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/pages/10c674/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/avatar.gif">
      <meta itemprop="name" content="钝悟 ◾ Dunwu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu Blog">
      <meta itemprop="description" content="钝悟的个人博客">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Dunwu Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/pages/10c674/" class="post-title-link" itemprop="url">MongoDB 索引</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-09-21 21:22:57" itemprop="dateCreated datePublished" datetime="2020-09-21T21:22:57+08:00">2020-09-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-09-23 18:54:25" itemprop="dateModified" datetime="2022-09-23T18:54:25+08:00">2022-09-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">数据库</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/%E6%96%87%E6%A1%A3%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">文档数据库</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/%E6%96%87%E6%A1%A3%E6%95%B0%E6%8D%AE%E5%BA%93/MongoDB/" itemprop="url" rel="index"><span itemprop="name">MongoDB</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>1.2k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="MongoDB-索引"><a href="#MongoDB-索引" class="headerlink" title="MongoDB 索引"></a>MongoDB 索引</h1><h2 id="MongoDB-索引简介"><a href="#MongoDB-索引简介" class="headerlink" title="MongoDB 索引简介"></a>MongoDB 索引简介</h2><h3 id="索引的作用"><a href="#索引的作用" class="headerlink" title="索引的作用"></a>索引的作用</h3><p><strong>MongoDB 在 collection 数据级别上定义索引</strong>。</p>
<p>索引通常能够极大的提高查询的效率。如果<strong>没有索引</strong>，MongoDB 在读取数据时<strong>必须扫描 collection 中的每个 document</strong> 并选取那些符合查询条件的记录。</p>
<p>这种扫描全集合的查询是非常低效的，特别是在处理大量的数据时。查询可能要花费几十秒甚至几分钟，这种性能开销是不可接受的。</p>
<p>索引是特殊的数据结构，索引存储在一个易于遍历读取的数据集合中，索引是对数据库表中一列或多列的值进行排序的一种结构。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/snap/20200921210621.svg" alt="img"></p>
<h3 id="createIndex-方法"><a href="#createIndex-方法" class="headerlink" title="createIndex() 方法"></a>createIndex() 方法</h3><p><strong>MongoDB 使用 <code>createIndex()</code> 方法来创建索引</strong>。</p>
<p><code>createIndex()</code> 语法如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="property">collection</span>.<span class="title function_">createIndex</span>( &lt;key and index type specification&gt;, &lt;options&gt; )</span><br></pre></td></tr></table></figure>

<p><code>createIndex()</code> 可选参数列表如下：</p>
<table>
<thead>
<tr>
<th align="left">Parameter</th>
<th align="left">Type</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody><tr>
<td align="left">background</td>
<td align="left">Boolean</td>
<td align="left">建索引过程会阻塞其它数据库操作，background 可指定以后台方式创建索引，即增加 “background” 可选参数。 “background” 默认值为<strong>false</strong>。</td>
</tr>
<tr>
<td align="left">unique</td>
<td align="left">Boolean</td>
<td align="left">建立的索引是否唯一。指定为 true 创建唯一索引。默认值为<strong>false</strong>.</td>
</tr>
<tr>
<td align="left">name</td>
<td align="left">string</td>
<td align="left">索引的名称。如果未指定，MongoDB 的通过连接索引的字段名和排序顺序生成一个索引名称。</td>
</tr>
<tr>
<td align="left">dropDups</td>
<td align="left">Boolean</td>
<td align="left"><strong>3.0+版本已废弃。</strong>在建立唯一索引时是否删除重复记录,指定 true 创建唯一索引。默认值为 <strong>false</strong>.</td>
</tr>
<tr>
<td align="left">sparse</td>
<td align="left">Boolean</td>
<td align="left">对文档中不存在的字段数据不启用索引；这个参数需要特别注意，如果设置为 true 的话，在索引字段中不会查询出不包含对应字段的文档.。默认值为 <strong>false</strong>.</td>
</tr>
<tr>
<td align="left">expireAfterSeconds</td>
<td align="left">integer</td>
<td align="left">指定一个以秒为单位的数值，完成 TTL 设定，设定集合的生存时间。</td>
</tr>
<tr>
<td align="left">v</td>
<td align="left">index version</td>
<td align="left">索引的版本号。默认的索引版本取决于 mongod 创建索引时运行的版本。</td>
</tr>
<tr>
<td align="left">weights</td>
<td align="left">document</td>
<td align="left">索引权重值，数值在 1 到 99,999 之间，表示该索引相对于其他索引字段的得分权重。</td>
</tr>
<tr>
<td align="left">default_language</td>
<td align="left">string</td>
<td align="left">对于文本索引，该参数决定了停用词及词干和词器的规则的列表。 默认为英语</td>
</tr>
<tr>
<td align="left">language_override</td>
<td align="left">string</td>
<td align="left">对于文本索引，该参数指定了包含在文档中的字段名，语言覆盖默认的 language，默认值为 language.</td>
</tr>
</tbody></table>
<p>【示例】使用 name 作为索引，并且按照降序排序</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.collection.create<span class="constructor">Index( &#123; <span class="params">name</span>: -1 &#125; )</span></span><br></pre></td></tr></table></figure>

<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><strong>官方</strong><ul>
<li><a target="_blank" rel="noopener" href="https://www.mongodb.com/">MongoDB 官网</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/mongodb/mongo">MongoDB Github</a></li>
<li><a target="_blank" rel="noopener" href="https://university.mongodb.com/">MongoDB 官方免费教程</a></li>
</ul>
</li>
<li><strong>教程</strong><ul>
<li><a target="_blank" rel="noopener" href="https://www.runoob.com/mongodb/mongodb-tutorial.html">MongoDB 教程</a></li>
<li><a target="_blank" rel="noopener" href="https://time.geekbang.org/course/intro/100040001">MongoDB 高手课</a></li>
</ul>
</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/pages/4574fe/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/avatar.gif">
      <meta itemprop="name" content="钝悟 ◾ Dunwu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu Blog">
      <meta itemprop="description" content="钝悟的个人博客">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Dunwu Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/pages/4574fe/" class="post-title-link" itemprop="url">MongoDB 事务</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-09-20 23:12:17" itemprop="dateCreated datePublished" datetime="2020-09-20T23:12:17+08:00">2020-09-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-09-23 18:54:25" itemprop="dateModified" datetime="2022-09-23T18:54:25+08:00">2022-09-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">数据库</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/%E6%96%87%E6%A1%A3%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">文档数据库</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/%E6%96%87%E6%A1%A3%E6%95%B0%E6%8D%AE%E5%BA%93/MongoDB/" itemprop="url" rel="index"><span itemprop="name">MongoDB</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>629</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="MongoDB-事务"><a href="#MongoDB-事务" class="headerlink" title="MongoDB 事务"></a>MongoDB 事务</h1><p>writeConcern 可以决定写操作到达多少个节点才算成功。</p>
<ul>
<li>默认：多节点复制集不做任何设定，所以是有可能丢失数据。</li>
<li><code>w: &quot;majority&quot;</code>：大部分节点确认，就视为写成功</li>
<li><code>w: &quot;all&quot;</code>：全部节点确认，才视为写成功</li>
</ul>
<p>journal 则定义如何才算成功。取值包括：</p>
<ul>
<li><code>true</code>：写操作落到 journal 文件中才算成功；</li>
<li><code>false</code>：写操作达到内存即算作成功。</li>
</ul>
<p>【示例】在集群中使用 writeConcern 参数</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="property">transaction</span>.<span class="title function_">insert</span>(&#123; <span class="attr">count</span>: <span class="number">1</span> &#125;, &#123; <span class="attr">writeConcern</span>: &#123; <span class="attr">w</span>: <span class="string">&#x27;majoriy&#x27;</span> &#125; &#125;)</span><br><span class="line">db.<span class="property">transaction</span>.<span class="title function_">insert</span>(&#123; <span class="attr">count</span>: <span class="number">1</span> &#125;, &#123; <span class="attr">writeConcern</span>: &#123; <span class="attr">w</span>: <span class="string">&#x27;4&#x27;</span> &#125; &#125;)</span><br><span class="line">db.<span class="property">transaction</span>.<span class="title function_">insert</span>(&#123; <span class="attr">count</span>: <span class="number">1</span> &#125;, &#123; <span class="attr">writeConcern</span>: &#123; <span class="attr">w</span>: <span class="string">&#x27;all&#x27;</span> &#125; &#125;)</span><br></pre></td></tr></table></figure>

<p>【示例】配置延迟节点，模拟网络延迟</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">conf</span>=rs.conf()</span><br><span class="line">conf.memebers[2].<span class="attribute">slaveDelay</span>=5</span><br><span class="line">conf.memebers[2].<span class="attribute">priority</span>=0</span><br><span class="line">rs.reconfig(conf)</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/pages/505407/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/avatar.gif">
      <meta itemprop="name" content="钝悟 ◾ Dunwu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu Blog">
      <meta itemprop="description" content="钝悟的个人博客">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Dunwu Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/pages/505407/" class="post-title-link" itemprop="url">MongoDB 复制</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-09-20 23:12:17" itemprop="dateCreated datePublished" datetime="2020-09-20T23:12:17+08:00">2020-09-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-09-23 18:54:25" itemprop="dateModified" datetime="2022-09-23T18:54:25+08:00">2022-09-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">数据库</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/%E6%96%87%E6%A1%A3%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">文档数据库</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/%E6%96%87%E6%A1%A3%E6%95%B0%E6%8D%AE%E5%BA%93/MongoDB/" itemprop="url" rel="index"><span itemprop="name">MongoDB</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>2.6k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>2 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="MongoDB-复制"><a href="#MongoDB-复制" class="headerlink" title="MongoDB 复制"></a>MongoDB 复制</h1><h2 id="副本和可用性"><a href="#副本和可用性" class="headerlink" title="副本和可用性"></a>副本和可用性</h2><p>副本可以<strong>提供冗余并提高数据可用性</strong>。在不同数据库服务器上使用多个数据副本，可以提供一定程度的容错能力，以防止单个数据库服务器宕机时，数据丢失。</p>
<p>在某些情况下，副本还可以<strong>提供更大的读取吞吐量</strong>。因为客户端可以将读取操作发送到不同的服务器。在不同数据中心中维护数据副本可以提高数据本地性和分布式应用程序的可用性。您还可以维护其他副本以用于专用目的：例如灾难恢复，报告或备份。</p>
<h2 id="MongoDB-副本"><a href="#MongoDB-副本" class="headerlink" title="MongoDB 副本"></a>MongoDB 副本</h2><p>MongoDB 中的副本集是一组维护相同数据集的 mongod 进程。一个副本集包含多个数据承载节点和一个仲裁器节点（可选）。在数据承载节点中，只有一个成员被视为主要节点，而其他节点则被视为次要节点。</p>
<p><strong>主节点负责接收所有写操作</strong>。副本集只能有一个主副本，能够以 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/write-concern/#writeconcern.%22majority%22"><code>&#123; w: &quot;majority&quot; &#125;</code></a> 来确认集群中节点的写操作成功情况；尽管在某些情况下，另一个 MongoDB 实例可能会暂时认为自己也是主要的。主节点在其操作日志（即 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/core/replica-set-oplog/">oplog</a>）中记录了对其数据集的所有更改。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/snap/20200920165054.svg" alt="img"></p>
<p><strong>从节点复制主节点的操作日志，并将操作应用于其数据集</strong>，以便同步主节点的数据。如果主节点不可用，则符合条件的从节点将选举新的主节点。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/snap/20200920165055.svg" alt="img"></p>
<p>在某些情况下（例如，有一个主节点和一个从节点，但由于成本限制，禁止添加另一个从节点），您可以选择将 mongod 实例作为仲裁节点添加到副本集。仲裁节点参加选举但不保存数据（即不提供数据冗余）。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/snap/20200920165053.svg" alt="img"></p>
<p>仲裁节点将永远是仲裁节点。在选举期间，主节点可能会降级成为次节点，而次节点可能会升级成为主节点。</p>
<h2 id="异步复制"><a href="#异步复制" class="headerlink" title="异步复制"></a>异步复制</h2><h3 id="慢操作"><a href="#慢操作" class="headerlink" title="慢操作"></a>慢操作</h3><p>从节点复制主节点的操作日志，并将操作异步应用于其数据集。通过从节点同步主节点的数据集，即使一个或多个成员失败，副本集（MongoDB 集群）也可以继续运行。</p>
<p>从 4.2 版本开始，副本集的从节点记录慢操作（操作时间比设置的阈值长）的日志条目。这些慢操作在 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/log-messages/#REPL"><code>REPL</code></a> 组件下的 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/program/mongod/#cmdoption-mongod-logpath">诊断日志</a> 中记录了日志消息，并使用了文本 <code>op: &lt;oplog entry&gt;</code> 花费了 <code>&lt;num&gt;ms</code>。这些慢操作日志条目仅取决于慢操作阈值，而不取决于日志级别（在系统级别或组件级别），配置级别或运行缓慢的采样率。探查器不会捕获缓慢的操作日志条目。</p>
<h3 id="复制延迟和流控"><a href="#复制延迟和流控" class="headerlink" title="复制延迟和流控"></a>复制延迟和流控</h3><p>复制延迟（<a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/glossary/#term-replication-lag">Replication lag</a>）是指将主节点上的写操作复制到从节点上所花费的时间。较短的延迟时间是可以接受的，但是随着复制延迟的增加，可能会出现严重的问题：比如在主节点上的缓存压力。</p>
<p>从 MongoDB 4.2 开始，管理员可以限制主节点的写入速率，使得大多数延迟时间保持在可配置的最大值 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/parameters/#param.flowControlTargetLagSeconds"><code>flowControlTargetLagSeconds</code></a> 以下。</p>
<p>默认情况下，流控是开启的。</p>
<p>启用流控后，随着延迟时间越来越接近 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/parameters/#param.flowControlTargetLagSeconds"><code>flowControlTargetLagSeconds</code></a>，主对象上的写操作必须先获得令牌，然后才能进行锁定并执行写操作。通过限制每秒发出的令牌数量，流控机制尝试将延迟保持在目标以下。</p>
<h2 id="故障转移"><a href="#故障转移" class="headerlink" title="故障转移"></a>故障转移</h2><p>当主节点与集群中的其他成员通信的时间超过配置的 <code>electionTimeoutMillis</code>（默认为 10 秒）时，符合选举要求的从节点将要求选举，并提名自己为新的主节点。集群尝试完成选举新主节点并恢复正常工作。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/snap/20200920175429.svg" alt="img"></p>
<p>选举完成前，副本集无法处理写入操作。如果将副本集配置为：在主节点处于脱机状态时，在次节点上运行，则副本集可以继续提供读取查询。</p>
<p>假设<a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/replica-configuration/#rsconf.settings">副本配置</a>采用默认配置，则集群选择新节点的时间通常不应超过 12 秒，这包括：将主节点标记为不可用并完成选举所需的时间。可以通过修改 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/replica-configuration/#rsconf.settings.electionTimeoutMillis"><code>settings.electionTimeoutMillis</code></a> 配置选项来调整此时间。网络延迟等因素可能会延长完成选举所需的时间，进而影响集群在没有主节点的情况下可以运行的时间。这些因素取决于集群实际的情况。</p>
<p>将默认为 10 秒的 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/replica-configuration/#rsconf.settings.electionTimeoutMillis"><code>electionTimeoutMillis</code></a> 选项数值缩小，可以更快地检测到主要故障。但是，由于网络延迟等因素，集群可能会更频繁地进行选举，即使该主节点实际上处于健康状态。这可能导致 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/write-concern/#wc-w">w : 1</a> 写操作的回滚次数增加。</p>
<p>应用程序的连接逻辑应包括对自动故障转移和后续选举的容错处理。从 MongoDB 3.6 开始，MongoDB 驱动程序可以检测到主节点的失联，并可以自动重试一次某些写入操作。</p>
<p>从 MongoDB4.4 开始，MongoDB 提供镜像读取：将可选举的从节点的最近访问的数据，预热为缓存。预热从节点的缓存可以帮助在选举后更快地恢复。</p>
<h2 id="读操作"><a href="#读操作" class="headerlink" title="读操作"></a>读操作</h2><h3 id="读优先"><a href="#读优先" class="headerlink" title="读优先"></a>读优先</h3><p>默认情况下，客户端从主节点读取数据；但是，客户端可以指定读取首选项，以将读取操作发送到从节点。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/snap/20200920204024.svg" alt="img"></p>
<p>异步复制到从节点意味着向从节点读取数据可能会返回与主节点不一致的数据。</p>
<p>包含读取操作的多文档事务必须使用读取主节点优先。给定事务中的所有操作必须路由到同一成员。</p>
<h3 id="数据可见性"><a href="#数据可见性" class="headerlink" title="数据可见性"></a>数据可见性</h3><p>根据读取的关注点，客户端可以在持久化写入前查看写入结果：</p>
<ul>
<li>不管写的 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/write-concern/">write concern</a> 如何设置，其他使用 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/read-concern-local/#readconcern.%22local%22"><code>&quot;local&quot;</code></a> 或 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/read-concern-available/#readconcern.%22available%22"><code>&quot;available&quot;</code></a> 的读配置的客户端都可以向发布客户端确认写操作之前看到写操作的结果。</li>
<li>使用 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/read-concern-local/#readconcern.%22local%22"><code>&quot;local&quot;</code></a> 或 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/read-concern-available/#readconcern.%22available%22"><code>&quot;available&quot;</code></a> 读取配置的客户端可以读取数据，这些数据随后可能会在副本集故障转移期间回滚。</li>
</ul>
<p>对于多文档事务中的操作，当事务提交时，在事务中进行的所有数据更改都将保存，并在事务外部可见。也就是说，事务在回滚其他事务时将不会提交其某些更改。在提交事务前，事务外部看不到在事务中进行的数据更改。</p>
<p>但是，当事务写入多个分片时，并非所有外部读操作都需要等待已提交事务的结果在所有分片上可见。例如，如果提交了一个事务，并且在分片 A 上可以看到写 1，但是在分片 B 上还看不到写 2，则在 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/read-concern-local/#readconcern.%22local%22"><code>&quot;local&quot;</code></a> 读配置级别，外部读取可以读取写 1 的结果而看不到写 2。</p>
<h3 id="镜像读取"><a href="#镜像读取" class="headerlink" title="镜像读取"></a>镜像读取</h3><p>从 MongoDB 4.4 开始，MongoDB 提供镜像读取以预热可选从节点（即优先级大于 0 的成员）的缓存。使用镜像读取（默认情况下已启用），主节点可以镜像它接收到的一部分操作，并将其发送给可选择的从节点的子集。子集的大小是可配置的。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><strong>官方</strong><ul>
<li><a target="_blank" rel="noopener" href="https://www.mongodb.com/">MongoDB 官网</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/mongodb/mongo">MongoDB Github</a></li>
<li><a target="_blank" rel="noopener" href="https://university.mongodb.com/">MongoDB 官方免费教程</a></li>
</ul>
</li>
<li><strong>教程</strong><ul>
<li><a target="_blank" rel="noopener" href="https://www.runoob.com/mongodb/mongodb-tutorial.html">MongoDB 教程</a></li>
<li><a target="_blank" rel="noopener" href="https://time.geekbang.org/course/intro/100040001">MongoDB 高手课</a></li>
</ul>
</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/pages/ad08f5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/avatar.gif">
      <meta itemprop="name" content="钝悟 ◾ Dunwu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu Blog">
      <meta itemprop="description" content="钝悟的个人博客">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Dunwu Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/pages/ad08f5/" class="post-title-link" itemprop="url">MongoDB 分片</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-09-20 23:12:17" itemprop="dateCreated datePublished" datetime="2020-09-20T23:12:17+08:00">2020-09-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-09-23 18:54:25" itemprop="dateModified" datetime="2022-09-23T18:54:25+08:00">2022-09-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">数据库</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/%E6%96%87%E6%A1%A3%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">文档数据库</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/%E6%96%87%E6%A1%A3%E6%95%B0%E6%8D%AE%E5%BA%93/MongoDB/" itemprop="url" rel="index"><span itemprop="name">MongoDB</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>2.1k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>2 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="MongoDB-分片"><a href="#MongoDB-分片" class="headerlink" title="MongoDB 分片"></a>MongoDB 分片</h1><h2 id="分片集群简介"><a href="#分片集群简介" class="headerlink" title="分片集群简介"></a>分片集群简介</h2><p>当 MongoDB 需要存储海量数据时，单节点不足以存储全量数据，且可能无法提供令人满意的吞吐量。所以，可以通过 MongoDB 分片机制来支持水平扩展。</p>
<h3 id="分片集群特点"><a href="#分片集群特点" class="headerlink" title="分片集群特点"></a>分片集群特点</h3><p>对应用完全透明</p>
<p>数据自动均衡</p>
<p>动态扩容</p>
<p>提供三种分片方式</p>
<h3 id="分片集群组件"><a href="#分片集群组件" class="headerlink" title="分片集群组件"></a>分片集群组件</h3><p>MongoDB 分片集群含以下组件：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/core/sharded-cluster-shards/">shard</a>：每个分片包含分片数据的子集。每个分片都可以部署为副本集。</li>
<li><a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/core/sharded-cluster-query-router/">mongos</a>：mongos 充当查询路由器，在客户端应用程序和分片集群之间提供接口。从 MongoDB 4.4 开始，mongos 可以支持 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/core/sharded-cluster-query-router/#mongos-hedged-reads">hedged reads</a> 以最大程度地减少延迟。</li>
<li><a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/core/sharded-cluster-config-servers/">config servers</a>：提供集群元数据存储和分片数据分布的映射。</li>
</ul>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/snap/20200920210057.svg" alt="img"></p>
<h3 id="分片集群的分布"><a href="#分片集群的分布" class="headerlink" title="分片集群的分布"></a>分片集群的分布</h3><p><strong>MongoDB 复制集以 collection 为单位</strong>，将数据分布在集群中的各个分片上。最多允许 1024 个分片。</p>
<p>MongoDB 复制集的分片之间数据不重复，只有当所有分片都正常时，才能完整工作。</p>
<p>MongoDB 数据库可以同时包含分片和未分片的集合的 collection。分片 collection 会分布在集群中各节点上。而未分片的 collection 存储在主节点上。每个数据库都有其自己的主节点。</p>
<p>分片和未分片的 collection：</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/snap/20200920212159.svg" alt="img"></p>
<h3 id="路由节点-mongos"><a href="#路由节点-mongos" class="headerlink" title="路由节点 mongos"></a>路由节点 mongos</h3><p>要连接 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/glossary/#term-sharded-cluster">MongoDB 分片集群</a>，必须连接到 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/glossary/#term-mongos"><code>mongos</code></a> 路由器。这包括分片和未分片的 collection。客户端不应该连接到单个分片节点进行读写操作。</p>
<p>连接 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/program/mongos/#bin.mongos"><code>mongos</code></a> 的方式和连接 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/program/mongod/#bin.mongod"><code>mongod</code></a> 相同，例如通过 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/program/mongo/#bin.mongo"><code>mongo</code></a> shell 或 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/drivers/?jump=docs">MongoDB 驱动程序</a>。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/snap/20200920212157.svg" alt="img"></p>
<p>路由节点的作用：</p>
<ul>
<li>提供集群的单一入口</li>
<li>转发应用端请求</li>
<li>选择合适数据节点进行读写</li>
<li>合并多个数据节点的返回</li>
</ul>
<p>一般，路由节点 mongos 建议至少 2 个。</p>
<h2 id="分片-Key"><a href="#分片-Key" class="headerlink" title="分片 Key"></a>分片 Key</h2><p>MongoDB 使用分片 Key 在各个分片之间分发 collection 的 document。分片 Key 由 document 中的一个或多个字段组成。</p>
<ul>
<li><p>从 MongoDB 4.4 开始，分片 collection 中的 document 可能缺少分片 Key 字段。在跨分片分布文档时，缺少分片 Key 字段将被视为具有空值，但在路由查询时则不会。</p>
</li>
<li><p>在 MongoDB 4.2 及更早版本中，分片 Key 字段必须在每个 document 中存在一个分片 collection。</p>
</li>
</ul>
<p>在分片 collection 时选择分片 Key。</p>
<ul>
<li>从 MongoDB 4.4 开始，您可以通过在现有 Key 中添加一个或多个后缀字段来优化 collection 的分片 Key。</li>
<li>在 MongoDB 4.2 和更低版本中，无法在分片后更改分片 Key 的选择。</li>
</ul>
<p>document 的分片键值决定了其在各个分片中的分布</p>
<ul>
<li>从 MongoDB 4.2 开始，除非您的分片 Key 字段是不可变的_id 字段，否则您可以更新 document 的分片键值。</li>
<li>在 MongoDB 4.0 及更低版本中，文档的分片 Key 字段值是不可变的。</li>
</ul>
<p>分片 Key 索引：要对已填充的 collection 进行分片，该 collection 必须具有以分片 Key 开头的索引。分片一个空 collection 时，如果该 collection 还没有针对指定分片 Key 的适当索引，则 MongoDB 会创建支持索引。</p>
<p>分片 Key 策略：分片 Key 的选择会影响分片集群的性能，效率和可伸缩性。分片 Key 及其后备索引的选择也会影响集群可以使用的分片策略。</p>
<p>MongoDB 分区将数据分片。每个分块都有基于分片 Key 的上下限。</p>
<p>为了在整个集群中的所有分片上实现块的均匀分布，均衡器在后台运行，并在各分片上迁移块。</p>
<h2 id="分片策略"><a href="#分片策略" class="headerlink" title="分片策略"></a>分片策略</h2><p>MongoDB 支持两种分片策略：Hash 分片和范围分片。</p>
<h3 id="Hash-分片"><a href="#Hash-分片" class="headerlink" title="Hash 分片"></a>Hash 分片</h3><p>Hash 分片策略会先计算分片 Key 字段值的哈希值；然后，根据分片键值为每个 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/glossary/#term-chunk">chunk</a> 分配一个范围。</p>
<blockquote>
<p>注意：使用哈希索引解析查询时，MongoDB 会自动计算哈希值，应用程序不需要计算哈希。</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/snap/20200920213343.svg" alt="img"></p>
<p>尽管分片 Key 范围可能是“接近”的，但它们的哈希值不太可能在同一 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/glossary/#term-chunk">chunk</a> 上。基于 Hash 的数据分发有助于更均匀的数据分布，尤其是在分片 Key 单调更改的数据集中。</p>
<p>但是，Hash 分片意味着对分片 Key 做范围查询时不太可能针对单个分片，从而导致更多的集群范围内的广播操作。</p>
<h3 id="范围分片"><a href="#范围分片" class="headerlink" title="范围分片"></a>范围分片</h3><p>范围分片根据分片 Key 值将数据划分为多个范围。然后，根据分片 Key 值为每个 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/glossary/#term-chunk">chunk</a> 分配一个范围。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/snap/20200920213345.svg" alt="img"></p>
<p>值比较近似的一系列分片 Key 更有可能驻留在同一 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/glossary/#term-chunk">chunk</a> 上。范围分片的效率取决于选择的分片 Key。分片 Key 考虑不周全会导致数据分布不均，这可能会削弱分片的某些优势或导致性能瓶颈。</p>
<h2 id="分片集群中的区域"><a href="#分片集群中的区域" class="headerlink" title="分片集群中的区域"></a>分片集群中的区域</h2><p>区域可以提高跨多个数据中心的分片集群的数据局部性。</p>
<p>在分片集群中，可以基于分片 Key 创建分片数据<a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/glossary/#term-zone">区域</a>。可以将每个区域与集群中的一个或多个分片关联。分片可以与任意数量的区域关联。在平衡的集群中，MongoDB 仅将区域覆盖的 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/glossary/#term-chunk">chunk</a> 迁移到与该区域关联的分片。</p>
<p>每个区域覆盖一个或多个分片 Key 值范围。区域覆盖的每个范围始终包括其上下边界。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/snap/20200920214854.svg" alt="img"></p>
<p>在定义要覆盖的区域的新范围时，必须使用分片 Key 中包含的字段。如果使用复合分片 Key，则范围必须包含分片 Key 的前缀。</p>
<p>选择分片 Key 时，应考虑将来可能使用的区域。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><strong>官方</strong><ul>
<li><a target="_blank" rel="noopener" href="https://www.mongodb.com/">MongoDB 官网</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/mongodb/mongo">MongoDB Github</a></li>
<li><a target="_blank" rel="noopener" href="https://university.mongodb.com/">MongoDB 官方免费教程</a></li>
</ul>
</li>
<li><strong>教程</strong><ul>
<li><a target="_blank" rel="noopener" href="https://www.runoob.com/mongodb/mongodb-tutorial.html">MongoDB 教程</a></li>
<li><a target="_blank" rel="noopener" href="https://time.geekbang.org/course/intro/100040001">MongoDB 高手课</a></li>
</ul>
</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/pages/7b0caf/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/avatar.gif">
      <meta itemprop="name" content="钝悟 ◾ Dunwu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu Blog">
      <meta itemprop="description" content="钝悟的个人博客">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Dunwu Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/pages/7b0caf/" class="post-title-link" itemprop="url">Mysql 常见问题</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-09-12 10:43:53" itemprop="dateCreated datePublished" datetime="2020-09-12T10:43:53+08:00">2020-09-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-09-23 18:54:25" itemprop="dateModified" datetime="2022-09-23T18:54:25+08:00">2022-09-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">数据库</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">关系型数据库</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/Mysql/" itemprop="url" rel="index"><span itemprop="name">Mysql</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>684</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Mysql-常见问题"><a href="#Mysql-常见问题" class="headerlink" title="Mysql 常见问题"></a>Mysql 常见问题</h1><blockquote>
<p><strong>📦 本文以及示例源码已归档在 <a target="_blank" rel="noopener" href="https://github.com/dunwu/db-tutorial/">db-tutorial</a></strong></p>
</blockquote>
<h2 id="为什么表数据删掉一半，表文件大小不变"><a href="#为什么表数据删掉一半，表文件大小不变" class="headerlink" title="为什么表数据删掉一半，表文件大小不变"></a>为什么表数据删掉一半，表文件大小不变</h2><p>【问题】数据库占用空间太大，我把一个最大的表删掉了一半的数据，怎么表文件的大小还是没变？</p>
<p>表数据既可以存在共享表空间里，也可以是单独的文件。这个行为是由参数 <code>innodb_file_per_table</code> 控制的：</p>
<ol>
<li>这个参数设置为 OFF 表示的是，表的数据放在系统共享表空间，也就是跟数据字典放在一起；</li>
<li>这个参数设置为 ON 表示的是，每个 InnoDB 表数据存储在一个以 .ibd 为后缀的文件中。</li>
</ol>
<p>从 MySQL 5.6.6 版本开始，它的默认值就是 ON 了。</p>
<p>我建议你不论使用 MySQL 的哪个版本，都将这个值设置为 ON。因为，一个表单独存储为一个文件更容易管理，而且在你不需要这个表的时候，通过 drop table 命令，系统就会直接删除这个文件。而如果是放在共享表空间中，即使表删掉了，空间也是不会回收的。</p>
<p>所以，<strong>将 innodb_file_per_table 设置为 ON，是推荐做法，我们接下来的讨论都是基于这个设置展开的。</strong></p>
<p>我们在删除整个表的时候，可以使用 drop table 命令回收表空间。但是，我们遇到的更多的删除数据的场景是删除某些行，这时就遇到了我们文章开头的问题：表中的数据被删除了，但是表空间却没有被回收。</p>
<p><strong>插入和删除操作可能会造成空洞</strong>。</p>
<ul>
<li>插入时，如果插入位置所在页已满，需要申请新页面。</li>
<li>删除时，不会删除所在页，而是将记录在页面的位置标记为可重用。</li>
</ul>
<p>所以，如果能够把这些空洞去掉，就能达到收缩表空间的目的。</p>
<p>要达到收缩空洞的目的，可以使用重建表的方式。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a target="_blank" rel="noopener" href="https://book.douban.com/subject/23008813/">《高性能 MySQL》</a></li>
<li><a target="_blank" rel="noopener" href="https://time.geekbang.org/column/intro/139">MySQL 实战 45 讲</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/pages/88c7d3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/avatar.gif">
      <meta itemprop="name" content="钝悟 ◾ Dunwu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu Blog">
      <meta itemprop="description" content="钝悟的个人博客">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Dunwu Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/pages/88c7d3/" class="post-title-link" itemprop="url">MongoDB 建模示例</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-09-12 10:43:53" itemprop="dateCreated datePublished" datetime="2020-09-12T10:43:53+08:00">2020-09-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-09-23 18:54:25" itemprop="dateModified" datetime="2022-09-23T18:54:25+08:00">2022-09-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">数据库</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/%E6%96%87%E6%A1%A3%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">文档数据库</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/%E6%96%87%E6%A1%A3%E6%95%B0%E6%8D%AE%E5%BA%93/MongoDB/" itemprop="url" rel="index"><span itemprop="name">MongoDB</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>14k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>13 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="MongoDB-建模示例"><a href="#MongoDB-建模示例" class="headerlink" title="MongoDB 建模示例"></a>MongoDB 建模示例</h1><h2 id="关系型模型"><a href="#关系型模型" class="headerlink" title="关系型模型"></a>关系型模型</h2><h3 id="嵌入式文档一对一关系模型"><a href="#嵌入式文档一对一关系模型" class="headerlink" title="嵌入式文档一对一关系模型"></a>嵌入式文档一对一关系模型</h3><h4 id="嵌入式文档一对一关系模型-嵌入式文档模式"><a href="#嵌入式文档一对一关系模型-嵌入式文档模式" class="headerlink" title="嵌入式文档一对一关系模型 - 嵌入式文档模式"></a>嵌入式文档一对一关系模型 - 嵌入式文档模式</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// patron document</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">   _id<span class="punctuation">:</span> <span class="string">&quot;joe&quot;</span><span class="punctuation">,</span></span><br><span class="line">   name<span class="punctuation">:</span> <span class="string">&quot;Joe Bookreader&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// address document</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">   patron_id<span class="punctuation">:</span> <span class="string">&quot;joe&quot;</span><span class="punctuation">,</span> <span class="comment">// reference to patron document</span></span><br><span class="line">   street<span class="punctuation">:</span> <span class="string">&quot;123 Fake Street&quot;</span><span class="punctuation">,</span></span><br><span class="line">   city<span class="punctuation">:</span> <span class="string">&quot;Faketon&quot;</span><span class="punctuation">,</span></span><br><span class="line">   state<span class="punctuation">:</span> <span class="string">&quot;MA&quot;</span><span class="punctuation">,</span></span><br><span class="line">   zip<span class="punctuation">:</span> <span class="string">&quot;12345&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>合并为：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;joe&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Joe Bookreader&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;street&quot;</span><span class="punctuation">:</span> <span class="string">&quot;123 Fake Street&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;city&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Faketon&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;state&quot;</span><span class="punctuation">:</span> <span class="string">&quot;MA&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;zip&quot;</span><span class="punctuation">:</span> <span class="string">&quot;12345&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="嵌入式文档一对一关系模型-子集模式"><a href="#嵌入式文档一对一关系模型-子集模式" class="headerlink" title="嵌入式文档一对一关系模型 - 子集模式"></a>嵌入式文档一对一关系模型 - 子集模式</h4><p>假设，有一个用于描述电影信息的 collection 定义：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;The Arrival of a Train&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;year&quot;</span><span class="punctuation">:</span> <span class="number">1896</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;runtime&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;released&quot;</span><span class="punctuation">:</span> ISODate(<span class="string">&quot;01-25-1896&quot;</span>)<span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;poster&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://ia.media-imdb.com/images/M/MV5BMjEyNDk5MDYzOV5BMl5BanBnXkFtZTgwNjIxMTEwMzE@._V1_SX300.jpg&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;plot&quot;</span><span class="punctuation">:</span> <span class="string">&quot;A group of people are standing in a straight line along the platform of a railway station, waiting for a train, which is seen coming at some distance. When the train stops at the platform, ...&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;fullplot&quot;</span><span class="punctuation">:</span> <span class="string">&quot;A group of people are standing in a straight line along the platform of a railway station, waiting for a train, which is seen coming at some distance. When the train stops at the platform, the line dissolves. The doors of the railway-cars open, and people on the platform help passengers to get off.&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;lastupdated&quot;</span><span class="punctuation">:</span> ISODate(<span class="string">&quot;2015-08-15T10:06:53&quot;</span>)<span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;movie&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;directors&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;Auguste Lumière&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Louis Lumière&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;imdb&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;rating&quot;</span><span class="punctuation">:</span> <span class="number">7.3</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;votes&quot;</span><span class="punctuation">:</span> <span class="number">5043</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">12</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;countries&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;France&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;genres&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;Documentary&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Short&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;tomatoes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;viewer&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;rating&quot;</span><span class="punctuation">:</span> <span class="number">3.7</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;numReviews&quot;</span><span class="punctuation">:</span> <span class="number">59</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;lastUpdated&quot;</span><span class="punctuation">:</span> ISODate(<span class="string">&quot;2020-01-09T00:02:53&quot;</span>)</span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>在应用中，有的场景只需要显示电影的简单浏览信息，不需要显示类似 fullplot、poster 这样的详细信息。因为，我们可以考虑将原结构一份为二，并通过 id 字段关联起来。</p>
<p>用于展示摘要信息的 movie collection</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// movie collection</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;The Arrival of a Train&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;year&quot;</span><span class="punctuation">:</span> <span class="number">1896</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;runtime&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;released&quot;</span><span class="punctuation">:</span> ISODate(<span class="string">&quot;1896-01-25&quot;</span>)<span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;movie&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;directors&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;Auguste Lumière&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Louis Lumière&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;countries&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;France&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;genres&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;Documentary&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Short&quot;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>用于展示细节信息的 movie_details collection</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// movie_details collection</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="number">156</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;movie_id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span> <span class="comment">// reference to the movie collection</span></span><br><span class="line">  <span class="attr">&quot;poster&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://ia.media-imdb.com/images/M/MV5BMjEyNDk5MDYzOV5BMl5BanBnXkFtZTgwNjIxMTEwMzE@._V1_SX300.jpg&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;plot&quot;</span><span class="punctuation">:</span> <span class="string">&quot;A group of people are standing in a straight line along the platform of a railway station, waiting for a train, which is seen coming at some distance. When the train stops at the platform, ...&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;fullplot&quot;</span><span class="punctuation">:</span> <span class="string">&quot;A group of people are standing in a straight line along the platform of a railway station, waiting for a train, which is seen coming at some distance. When the train stops at the platform, the line dissolves. The doors of the railway-cars open, and people on the platform help passengers to get off.&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;lastupdated&quot;</span><span class="punctuation">:</span> ISODate(<span class="string">&quot;2015-08-15T10:06:53&quot;</span>)<span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;imdb&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;rating&quot;</span><span class="punctuation">:</span> <span class="number">7.3</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;votes&quot;</span><span class="punctuation">:</span> <span class="number">5043</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">12</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;tomatoes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;viewer&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;rating&quot;</span><span class="punctuation">:</span> <span class="number">3.7</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;numReviews&quot;</span><span class="punctuation">:</span> <span class="number">59</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;lastUpdated&quot;</span><span class="punctuation">:</span> ISODate(<span class="string">&quot;2020-01-29T00:02:53&quot;</span>)</span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="嵌入式文档一对多关系模型"><a href="#嵌入式文档一对多关系模型" class="headerlink" title="嵌入式文档一对多关系模型"></a>嵌入式文档一对多关系模型</h3><h4 id="嵌入式文档一对多关系模型-嵌入式文档模式"><a href="#嵌入式文档一对多关系模型-嵌入式文档模式" class="headerlink" title="嵌入式文档一对多关系模型 - 嵌入式文档模式"></a>嵌入式文档一对多关系模型 - 嵌入式文档模式</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// patron document</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">   _id<span class="punctuation">:</span> <span class="string">&quot;joe&quot;</span><span class="punctuation">,</span></span><br><span class="line">   name<span class="punctuation">:</span> <span class="string">&quot;Joe Bookreader&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// address documents</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">   patron_id<span class="punctuation">:</span> <span class="string">&quot;joe&quot;</span><span class="punctuation">,</span> <span class="comment">// reference to patron document</span></span><br><span class="line">   street<span class="punctuation">:</span> <span class="string">&quot;123 Fake Street&quot;</span><span class="punctuation">,</span></span><br><span class="line">   city<span class="punctuation">:</span> <span class="string">&quot;Faketon&quot;</span><span class="punctuation">,</span></span><br><span class="line">   state<span class="punctuation">:</span> <span class="string">&quot;MA&quot;</span><span class="punctuation">,</span></span><br><span class="line">   zip<span class="punctuation">:</span> <span class="string">&quot;12345&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">   patron_id<span class="punctuation">:</span> <span class="string">&quot;joe&quot;</span><span class="punctuation">,</span></span><br><span class="line">   street<span class="punctuation">:</span> <span class="string">&quot;1 Some Other Street&quot;</span><span class="punctuation">,</span></span><br><span class="line">   city<span class="punctuation">:</span> <span class="string">&quot;Boston&quot;</span><span class="punctuation">,</span></span><br><span class="line">   state<span class="punctuation">:</span> <span class="string">&quot;MA&quot;</span><span class="punctuation">,</span></span><br><span class="line">   zip<span class="punctuation">:</span> <span class="string">&quot;12345&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>合并为：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;joe&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Joe Bookreader&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;addresses&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;street&quot;</span><span class="punctuation">:</span> <span class="string">&quot;123 Fake Street&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;city&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Faketon&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;state&quot;</span><span class="punctuation">:</span> <span class="string">&quot;MA&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;zip&quot;</span><span class="punctuation">:</span> <span class="string">&quot;12345&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;street&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1 Some Other Street&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;city&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Boston&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;state&quot;</span><span class="punctuation">:</span> <span class="string">&quot;MA&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;zip&quot;</span><span class="punctuation">:</span> <span class="string">&quot;12345&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="嵌入式文档一对多关系模型-子集模式"><a href="#嵌入式文档一对多关系模型-子集模式" class="headerlink" title="嵌入式文档一对多关系模型 - 子集模式"></a>嵌入式文档一对多关系模型 - 子集模式</h4><p>考虑一个电商网站用于表示商品的 collection：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Super Widget&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;This is the most useful item in your toolbox.&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> NumberDecimal(<span class="string">&quot;119.99&quot;</span>)<span class="punctuation">,</span> <span class="attr">&quot;currency&quot;</span><span class="punctuation">:</span> <span class="string">&quot;USD&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;reviews&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;review_id&quot;</span><span class="punctuation">:</span> <span class="number">786</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;review_author&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Kristina&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;review_text&quot;</span><span class="punctuation">:</span> <span class="string">&quot;This is indeed an amazing widget.&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;published_date&quot;</span><span class="punctuation">:</span> ISODate(<span class="string">&quot;2019-02-18&quot;</span>)</span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;review_id&quot;</span><span class="punctuation">:</span> <span class="number">785</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;review_author&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Trina&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;review_text&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Nice product. Slow shipping.&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;published_date&quot;</span><span class="punctuation">:</span> ISODate(<span class="string">&quot;2019-02-17&quot;</span>)</span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    ...<span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;review_id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;review_author&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Hans&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;review_text&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Meh, it&#x27;s okay.&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;published_date&quot;</span><span class="punctuation">:</span> ISODate(<span class="string">&quot;2017-12-06&quot;</span>)</span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>评论按时间倒序排列。 当用户访问产品页面时，应用程序将加载十条最近的评论。可以将集合分为两个集合，而不是与产品一起存储所有评论：</p>
<p>产品集合存储有关每个产品的信息，包括产品的十个最新评论：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Super Widget&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;This is the most useful item in your toolbox.&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> NumberDecimal(<span class="string">&quot;119.99&quot;</span>)<span class="punctuation">,</span> <span class="attr">&quot;currency&quot;</span><span class="punctuation">:</span> <span class="string">&quot;USD&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;reviews&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;review_id&quot;</span><span class="punctuation">:</span> <span class="number">786</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;review_author&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Kristina&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;review_text&quot;</span><span class="punctuation">:</span> <span class="string">&quot;This is indeed an amazing widget.&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;published_date&quot;</span><span class="punctuation">:</span> ISODate(<span class="string">&quot;2019-02-18&quot;</span>)</span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;review_id&quot;</span><span class="punctuation">:</span> <span class="number">776</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;review_author&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Pablo&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;review_text&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Amazing!&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;published_date&quot;</span><span class="punctuation">:</span> ISODate(<span class="string">&quot;2019-02-16&quot;</span>)</span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>review collection 存储所有的评论</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;review_id&quot;</span><span class="punctuation">:</span> <span class="number">786</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;product_id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;review_author&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Kristina&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;review_text&quot;</span><span class="punctuation">:</span> <span class="string">&quot;This is indeed an amazing widget.&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;published_date&quot;</span><span class="punctuation">:</span> ISODate(<span class="string">&quot;2019-02-18&quot;</span>)</span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;review_id&quot;</span><span class="punctuation">:</span> <span class="number">785</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;product_id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;review_author&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Trina&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;review_text&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Nice product. Slow shipping.&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;published_date&quot;</span><span class="punctuation">:</span> ISODate(<span class="string">&quot;2019-02-17&quot;</span>)</span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line">...</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;review_id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;product_id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;review_author&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Hans&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;review_text&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Meh, it&#x27;s okay.&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;published_date&quot;</span><span class="punctuation">:</span> ISODate(<span class="string">&quot;2017-12-06&quot;</span>)</span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="引用式文档一对多关系模型"><a href="#引用式文档一对多关系模型" class="headerlink" title="引用式文档一对多关系模型"></a>引用式文档一对多关系模型</h3><p>考虑以下映射出版商和书籍关系的示例。</p>
<p>该示例说明了引用式文档的优点，以避免重复发布者信息。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">   title<span class="punctuation">:</span> <span class="string">&quot;MongoDB: The Definitive Guide&quot;</span><span class="punctuation">,</span></span><br><span class="line">   author<span class="punctuation">:</span> <span class="punctuation">[</span> <span class="string">&quot;Kristina Chodorow&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Mike Dirolf&quot;</span> <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">   published_date<span class="punctuation">:</span> ISODate(<span class="string">&quot;2010-09-24&quot;</span>)<span class="punctuation">,</span></span><br><span class="line">   pages<span class="punctuation">:</span> <span class="number">216</span><span class="punctuation">,</span></span><br><span class="line">   language<span class="punctuation">:</span> <span class="string">&quot;English&quot;</span><span class="punctuation">,</span></span><br><span class="line">   publisher<span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              name<span class="punctuation">:</span> <span class="string">&quot;O&#x27;Reilly Media&quot;</span><span class="punctuation">,</span></span><br><span class="line">              founded<span class="punctuation">:</span> <span class="number">1980</span><span class="punctuation">,</span></span><br><span class="line">              location<span class="punctuation">:</span> <span class="string">&quot;CA&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">   title<span class="punctuation">:</span> <span class="string">&quot;50 Tips and Tricks for MongoDB Developer&quot;</span><span class="punctuation">,</span></span><br><span class="line">   author<span class="punctuation">:</span> <span class="string">&quot;Kristina Chodorow&quot;</span><span class="punctuation">,</span></span><br><span class="line">   published_date<span class="punctuation">:</span> ISODate(<span class="string">&quot;2011-05-06&quot;</span>)<span class="punctuation">,</span></span><br><span class="line">   pages<span class="punctuation">:</span> <span class="number">68</span><span class="punctuation">,</span></span><br><span class="line">   language<span class="punctuation">:</span> <span class="string">&quot;English&quot;</span><span class="punctuation">,</span></span><br><span class="line">   publisher<span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              name<span class="punctuation">:</span> <span class="string">&quot;O&#x27;Reilly Media&quot;</span><span class="punctuation">,</span></span><br><span class="line">              founded<span class="punctuation">:</span> <span class="number">1980</span><span class="punctuation">,</span></span><br><span class="line">              location<span class="punctuation">:</span> <span class="string">&quot;CA&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>为避免重复出版商数据，可以使用引用型文档，并将出版商信息与书本分开保存。 使用引用时，关系的增长决定了将引用存储在何处。 如果每个出版商的图书数量很少且增长有限，则有时将图书参考存储在出版商文档中可能会很有用。 否则，如果每个发布者的书籍数量不受限制，则此数据模型将导致可变的，不断增长的数组，如以下示例所示：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">   name<span class="punctuation">:</span> <span class="string">&quot;O&#x27;Reilly Media&quot;</span><span class="punctuation">,</span></span><br><span class="line">   founded<span class="punctuation">:</span> <span class="number">1980</span><span class="punctuation">,</span></span><br><span class="line">   location<span class="punctuation">:</span> <span class="string">&quot;CA&quot;</span><span class="punctuation">,</span></span><br><span class="line">   books<span class="punctuation">:</span> <span class="punctuation">[</span><span class="number">123456789</span><span class="punctuation">,</span> <span class="number">234567890</span><span class="punctuation">,</span> ...<span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    _id<span class="punctuation">:</span> <span class="number">123456789</span><span class="punctuation">,</span></span><br><span class="line">    title<span class="punctuation">:</span> <span class="string">&quot;MongoDB: The Definitive Guide&quot;</span><span class="punctuation">,</span></span><br><span class="line">    author<span class="punctuation">:</span> <span class="punctuation">[</span> <span class="string">&quot;Kristina Chodorow&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Mike Dirolf&quot;</span> <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    published_date<span class="punctuation">:</span> ISODate(<span class="string">&quot;2010-09-24&quot;</span>)<span class="punctuation">,</span></span><br><span class="line">    pages<span class="punctuation">:</span> <span class="number">216</span><span class="punctuation">,</span></span><br><span class="line">    language<span class="punctuation">:</span> <span class="string">&quot;English&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">   _id<span class="punctuation">:</span> <span class="number">234567890</span><span class="punctuation">,</span></span><br><span class="line">   title<span class="punctuation">:</span> <span class="string">&quot;50 Tips and Tricks for MongoDB Developer&quot;</span><span class="punctuation">,</span></span><br><span class="line">   author<span class="punctuation">:</span> <span class="string">&quot;Kristina Chodorow&quot;</span><span class="punctuation">,</span></span><br><span class="line">   published_date<span class="punctuation">:</span> ISODate(<span class="string">&quot;2011-05-06&quot;</span>)<span class="punctuation">,</span></span><br><span class="line">   pages<span class="punctuation">:</span> <span class="number">68</span><span class="punctuation">,</span></span><br><span class="line">   language<span class="punctuation">:</span> <span class="string">&quot;English&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>为了避免可变的，增长的数组，请将发行者参考存储在书籍文档中：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">   _id<span class="punctuation">:</span> <span class="string">&quot;oreilly&quot;</span><span class="punctuation">,</span></span><br><span class="line">   name<span class="punctuation">:</span> <span class="string">&quot;O&#x27;Reilly Media&quot;</span><span class="punctuation">,</span></span><br><span class="line">   founded<span class="punctuation">:</span> <span class="number">1980</span><span class="punctuation">,</span></span><br><span class="line">   location<span class="punctuation">:</span> <span class="string">&quot;CA&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">   _id<span class="punctuation">:</span> <span class="number">123456789</span><span class="punctuation">,</span></span><br><span class="line">   title<span class="punctuation">:</span> <span class="string">&quot;MongoDB: The Definitive Guide&quot;</span><span class="punctuation">,</span></span><br><span class="line">   author<span class="punctuation">:</span> <span class="punctuation">[</span> <span class="string">&quot;Kristina Chodorow&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Mike Dirolf&quot;</span> <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">   published_date<span class="punctuation">:</span> ISODate(<span class="string">&quot;2010-09-24&quot;</span>)<span class="punctuation">,</span></span><br><span class="line">   pages<span class="punctuation">:</span> <span class="number">216</span><span class="punctuation">,</span></span><br><span class="line">   language<span class="punctuation">:</span> <span class="string">&quot;English&quot;</span><span class="punctuation">,</span></span><br><span class="line">   publisher_id<span class="punctuation">:</span> <span class="string">&quot;oreilly&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">   _id<span class="punctuation">:</span> <span class="number">234567890</span><span class="punctuation">,</span></span><br><span class="line">   title<span class="punctuation">:</span> <span class="string">&quot;50 Tips and Tricks for MongoDB Developer&quot;</span><span class="punctuation">,</span></span><br><span class="line">   author<span class="punctuation">:</span> <span class="string">&quot;Kristina Chodorow&quot;</span><span class="punctuation">,</span></span><br><span class="line">   published_date<span class="punctuation">:</span> ISODate(<span class="string">&quot;2011-05-06&quot;</span>)<span class="punctuation">,</span></span><br><span class="line">   pages<span class="punctuation">:</span> <span class="number">68</span><span class="punctuation">,</span></span><br><span class="line">   language<span class="punctuation">:</span> <span class="string">&quot;English&quot;</span><span class="punctuation">,</span></span><br><span class="line">   publisher_id<span class="punctuation">:</span> <span class="string">&quot;oreilly&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="树形结构模型"><a href="#树形结构模型" class="headerlink" title="树形结构模型"></a>树形结构模型</h2><p><img src="https://raw.githubusercontent.com/dunwu/images/dev/snap/20200911194846.svg" alt="img"></p>
<h3 id="具有父节点的树形结构模型"><a href="#具有父节点的树形结构模型" class="headerlink" title="具有父节点的树形结构模型"></a>具有父节点的树形结构模型</h3><p>上图结构可以用父引用来表示：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">db.categories.insertMany(<span class="punctuation">[</span></span><br><span class="line">  <span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;MongoDB&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;parent&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Databases&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;dbm&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;parent&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Databases&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Databases&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;parent&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Programming&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Languages&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;parent&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Programming&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Programming&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;parent&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Books&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Books&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;parent&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li><p>检索节点的父节点：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.categories.find<span class="constructor">One( &#123; <span class="params">_id</span>: <span class="string">&quot;MongoDB&quot;</span> &#125; )</span>.parent</span><br></pre></td></tr></table></figure>
</li>
<li><p>可以在父字段上创建索引以启用父节点的快速搜索：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.categories.create<span class="constructor">Index( &#123; <span class="params">parent</span>: 1 &#125; )</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>可以通过父字段查询找到其直接子节点：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.categories.<span class="built_in">find</span>( &#123; parent: <span class="string">&quot;Databases&quot;</span> &#125; )</span><br></pre></td></tr></table></figure>
</li>
<li><p>检索子树，可以参考： <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/operator/aggregation/graphLookup/#pipe._S_graphLookup"><code>$graphLookup</code></a>.</p>
</li>
</ul>
<h3 id="具有子节点的树形结构模型"><a href="#具有子节点的树形结构模型" class="headerlink" title="具有子节点的树形结构模型"></a>具有子节点的树形结构模型</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">db.categories.insertMany(<span class="punctuation">[</span></span><br><span class="line">  <span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;MongoDB&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;children&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;dbm&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;children&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Databases&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;children&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;MongoDB&quot;</span><span class="punctuation">,</span> <span class="string">&quot;dbm&quot;</span><span class="punctuation">]</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Languages&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;children&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Programming&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;children&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;Databases&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Languages&quot;</span><span class="punctuation">]</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Books&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;children&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;Programming&quot;</span><span class="punctuation">]</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li><p>检索节点的 children：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.categories.find<span class="constructor">One( &#123; <span class="params">_id</span>: <span class="string">&quot;Databases&quot;</span> &#125; )</span>.children</span><br></pre></td></tr></table></figure>
</li>
<li><p>可以在 children 字段上创建索引以启用子节点的快速搜索：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.categories.create<span class="constructor">Index( &#123; <span class="params">children</span>: 1 &#125; )</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>可以在 children 字段中查询节点，以找到其父节点及其兄弟节点：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.categories.<span class="built_in">find</span>( &#123; children: <span class="string">&quot;MongoDB&quot;</span> &#125; )</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="具有祖先的树形结构模型"><a href="#具有祖先的树形结构模型" class="headerlink" title="具有祖先的树形结构模型"></a>具有祖先的树形结构模型</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">db.categories.insertMany(<span class="punctuation">[</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;MongoDB&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ancestors&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;Books&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Programming&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Databases&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;parent&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Databases&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;dbm&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ancestors&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;Books&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Programming&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Databases&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;parent&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Databases&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Databases&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ancestors&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;Books&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Programming&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;parent&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Programming&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Languages&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ancestors&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;Books&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Programming&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;parent&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Programming&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Programming&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;ancestors&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;Books&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span> <span class="attr">&quot;parent&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Books&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Books&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;ancestors&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span> <span class="attr">&quot;parent&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li><p>检索节点的祖先或路径的查询是快速而直接的：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.categories.findOne(<span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;MongoDB&quot;</span> <span class="punctuation">&#125;</span>).ancestors</span><br></pre></td></tr></table></figure>
</li>
<li><p>可以在 ancestors 字段上创建索引，以启用祖先节点的快速搜索：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.categories.createIndex(<span class="punctuation">&#123;</span> <span class="attr">&quot;ancestors&quot;</span><span class="punctuation">:</span> <span class="number">1</span> <span class="punctuation">&#125;</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>可以通过 ancestors 字段查询查找其所有后代：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.categories.find(<span class="punctuation">&#123;</span> <span class="attr">&quot;ancestors&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Programming&quot;</span> <span class="punctuation">&#125;</span>)</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="具有实体化路径的树形结构模型"><a href="#具有实体化路径的树形结构模型" class="headerlink" title="具有实体化路径的树形结构模型"></a>具有实体化路径的树形结构模型</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">db.categories.insertMany(<span class="punctuation">[</span></span><br><span class="line">  <span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Books&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Programming&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;,Books,&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Databases&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;,Books,Programming,&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Languages&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;,Books,Programming,&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;MongoDB&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;,Books,Programming,Databases,&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;dbm&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;,Books,Programming,Databases,&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li><p>可以查询以检索整个树，并按字段路径排序：</p>
<figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.categories.<span class="built_in">find</span>().<span class="built_in">sort</span>( &#123; <span class="built_in">path</span>: <span class="number">1</span> &#125; )</span><br></pre></td></tr></table></figure>
</li>
<li><p>可以在 path 字段上使用正则表达式来查找 Programming 的后代</p>
<figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.categories.<span class="built_in">find</span>( &#123; <span class="attr">path</span>: <span class="regexp">/,Programming,/</span> &#125; )</span><br></pre></td></tr></table></figure>
</li>
<li><p>可以检索 Books 的后代，其中 Books 也位于层次结构的最高级别：</p>
<figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.categories.<span class="built_in">find</span>( &#123; <span class="attr">path</span>: <span class="regexp">/^,Books,/</span> &#125; )</span><br></pre></td></tr></table></figure>
</li>
<li><p>要在 path 字段上创建索引，请使用以下调用：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.categories.create<span class="constructor">Index( &#123; <span class="params">path</span>: 1 &#125; )</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="具有嵌套集的树形结构模型"><a href="#具有嵌套集的树形结构模型" class="headerlink" title="具有嵌套集的树形结构模型"></a>具有嵌套集的树形结构模型</h3><p><img src="https://raw.githubusercontent.com/dunwu/images/dev/snap/20200911204252.svg" alt="img"></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="property">categories</span>.<span class="title function_">insertMany</span>([</span><br><span class="line">  &#123; <span class="attr">_id</span>: <span class="string">&#x27;Books&#x27;</span>, <span class="attr">parent</span>: <span class="number">0</span>, <span class="attr">left</span>: <span class="number">1</span>, <span class="attr">right</span>: <span class="number">12</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">_id</span>: <span class="string">&#x27;Programming&#x27;</span>, <span class="attr">parent</span>: <span class="string">&#x27;Books&#x27;</span>, <span class="attr">left</span>: <span class="number">2</span>, <span class="attr">right</span>: <span class="number">11</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">_id</span>: <span class="string">&#x27;Languages&#x27;</span>, <span class="attr">parent</span>: <span class="string">&#x27;Programming&#x27;</span>, <span class="attr">left</span>: <span class="number">3</span>, <span class="attr">right</span>: <span class="number">4</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">_id</span>: <span class="string">&#x27;Databases&#x27;</span>, <span class="attr">parent</span>: <span class="string">&#x27;Programming&#x27;</span>, <span class="attr">left</span>: <span class="number">5</span>, <span class="attr">right</span>: <span class="number">10</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">_id</span>: <span class="string">&#x27;MongoDB&#x27;</span>, <span class="attr">parent</span>: <span class="string">&#x27;Databases&#x27;</span>, <span class="attr">left</span>: <span class="number">6</span>, <span class="attr">right</span>: <span class="number">7</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">_id</span>: <span class="string">&#x27;dbm&#x27;</span>, <span class="attr">parent</span>: <span class="string">&#x27;Databases&#x27;</span>, <span class="attr">left</span>: <span class="number">8</span>, <span class="attr">right</span>: <span class="number">9</span> &#125;</span><br><span class="line">])</span><br></pre></td></tr></table></figure>

<p>可以查询以检索节点的后代：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> databaseCategory = db.<span class="property">categories</span>.<span class="title function_">findOne</span>(&#123; <span class="attr">_id</span>: <span class="string">&#x27;Databases&#x27;</span> &#125;)</span><br><span class="line">db.<span class="property">categories</span>.<span class="title function_">find</span>(&#123;</span><br><span class="line">  <span class="attr">left</span>: &#123; <span class="attr">$gt</span>: databaseCategory.<span class="property">left</span> &#125;,</span><br><span class="line">  <span class="attr">right</span>: &#123; <span class="attr">$lt</span>: databaseCategory.<span class="property">right</span> &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="设计模式"><a href="#设计模式" class="headerlink" title="设计模式"></a>设计模式</h2><h3 id="大文档，很多列，很多索引"><a href="#大文档，很多列，很多索引" class="headerlink" title="大文档，很多列，很多索引"></a>大文档，很多列，很多索引</h3><p>解决方案是：列转行</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/snap/20200919225901.png" alt="img"></p>
<h3 id="管理文档不同版本"><a href="#管理文档不同版本" class="headerlink" title="管理文档不同版本"></a>管理文档不同版本</h3><p>MongoDB 文档格式非常灵活，势必会带来版本维护上的难度。</p>
<p>解决方案是：可以增加一个版本号字段</p>
<ul>
<li>快速过滤掉不需要升级的文档</li>
<li>升级时，对不同版本的文档做不同处理</li>
</ul>
<h3 id="统计网页点击量"><a href="#统计网页点击量" class="headerlink" title="统计网页点击量"></a>统计网页点击量</h3><p>统计数据精确性要求并不是十分重要。</p>
<p>解决方案：用近似计算</p>
<p>每隔 10 次写一次：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;$inc&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;views&quot;</span><span class="punctuation">:</span> <span class="number">1</span> <span class="punctuation">&#125;</span> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="精确统计"><a href="#精确统计" class="headerlink" title="精确统计"></a>精确统计</h3><p>解决方案：使用预聚合</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/applications/data-models/">Data Model Examples and Patterns</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/pages/562f99/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/avatar.gif">
      <meta itemprop="name" content="钝悟 ◾ Dunwu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu Blog">
      <meta itemprop="description" content="钝悟的个人博客">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Dunwu Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/pages/562f99/" class="post-title-link" itemprop="url">MongoDB 建模</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-09-09 20:47:14" itemprop="dateCreated datePublished" datetime="2020-09-09T20:47:14+08:00">2020-09-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-09-23 18:54:25" itemprop="dateModified" datetime="2022-09-23T18:54:25+08:00">2022-09-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">数据库</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/%E6%96%87%E6%A1%A3%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">文档数据库</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/%E6%96%87%E6%A1%A3%E6%95%B0%E6%8D%AE%E5%BA%93/MongoDB/" itemprop="url" rel="index"><span itemprop="name">MongoDB</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>8.6k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>8 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="MongoDB-建模"><a href="#MongoDB-建模" class="headerlink" title="MongoDB 建模"></a>MongoDB 建模</h1><p>MongoDB 的数据模式是一种灵活模式，关系型数据库要求你在插入数据之前必须先定义好一个表的模式结构，而 MongoDB 的集合则并不限制 document 结构。这种灵活性让对象和数据库文档之间的映射变得很容易。即使数据记录之间有很大的变化，每个文档也可以很好的映射到各条不同的记录。 当然在实际使用中，同一个集合中的文档往往都有一个比较类似的结构。</p>
<p>数据模型设计中最具挑战性的是在应用程序需求，数据库引擎性能要求和数据读写模式之间做权衡考量。当设计数据模型的时候，一定要考虑应用程序对数据的使用模式（如查询，更新和处理）以及数据本身的天然结构。</p>
<h2 id="MongoDB-数据建模入门"><a href="#MongoDB-数据建模入门" class="headerlink" title="MongoDB 数据建模入门"></a>MongoDB 数据建模入门</h2><blockquote>
<p>参考：<a target="_blank" rel="noopener" href="https://docs.mongodb.com/guides/server/introduction/#what-you-ll-need">https://docs.mongodb.com/guides/server/introduction/#what-you-ll-need</a></p>
</blockquote>
<h3 id="（一）定义数据集"><a href="#（一）定义数据集" class="headerlink" title="（一）定义数据集"></a>（一）定义数据集</h3><p>当需要建立数据存储时，首先应该思考以下问题：需要存储哪些数据？这些字段之间如何关联？</p>
<p>这是一个数据建模的过程。目标是<strong>将业务需求抽象为逻辑模型</strong>。</p>
<p>假设这样一个场景：我们需要建立数据库以跟踪物料及其数量，大小，标签和等级。</p>
<p>如果是存储在 RDBMS，可能以下的数据表：</p>
<table>
<thead>
<tr>
<th align="left">name</th>
<th align="left">quantity</th>
<th align="left">size</th>
<th align="left">status</th>
<th align="left">tags</th>
<th align="left">rating</th>
</tr>
</thead>
<tbody><tr>
<td align="left">journal</td>
<td align="left">25</td>
<td align="left">14x21,cm</td>
<td align="left">A</td>
<td align="left">brown, lined</td>
<td align="left">9</td>
</tr>
<tr>
<td align="left">notebook</td>
<td align="left">50</td>
<td align="left">8.5x11,in</td>
<td align="left">A</td>
<td align="left">college-ruled,perforated</td>
<td align="left">8</td>
</tr>
<tr>
<td align="left">paper</td>
<td align="left">100</td>
<td align="left">8.5x11,in</td>
<td align="left">D</td>
<td align="left">watercolor</td>
<td align="left">10</td>
</tr>
<tr>
<td align="left">planner</td>
<td align="left">75</td>
<td align="left">22.85x30,cm</td>
<td align="left">D</td>
<td align="left">2019</td>
<td align="left">10</td>
</tr>
<tr>
<td align="left">postcard</td>
<td align="left">45</td>
<td align="left">10x,cm</td>
<td align="left">D</td>
<td align="left">double-sided,white</td>
<td align="left">2</td>
</tr>
</tbody></table>
<h3 id="（二）思考-JSON-结构"><a href="#（二）思考-JSON-结构" class="headerlink" title="（二）思考 JSON 结构"></a>（二）思考 JSON 结构</h3><p>从上例中可以看出，表似乎是存储数据的好地方，但该数据集中的字段需要多个值，如果在单个列中建模，则不容易搜索或显示（对于 例如–大小和标签）。</p>
<p>在 SQL 数据库中，您可以通过创建关系表来解决此问题。</p>
<p>在 MongoDB 中，数据存储为文档（document）。 这些文档以 JSON（JavaScript 对象表示法）格式存储在 MongoDB 中。 JSON 文档支持嵌入式字段，因此相关数据和数据列表可以与文档一起存储，而不是与外部表一起存储。</p>
<p>JSON 格式为键&#x2F;值对。 在 JSON 文档中，字段名和值用冒号分隔，字段名和值对用逗号分隔，并且字段集封装在“大括号”（<code>&#123;&#125;</code>）中。</p>
<p>如果要开始对上面的行之一进行建模，例如此行：</p>
<table>
<thead>
<tr>
<th align="left">name</th>
<th align="left">quantity</th>
<th align="left">size</th>
<th align="left">status</th>
<th align="left">tags</th>
<th align="left">rating</th>
</tr>
</thead>
<tbody><tr>
<td align="left">notebook</td>
<td align="left">50</td>
<td align="left">8.5x11,in</td>
<td align="left">A</td>
<td align="left">college-ruled,perforated</td>
<td align="left">8</td>
</tr>
</tbody></table>
<p>您可以从 name 和 quantity 字段开始。 在 JSON 中，这些字段如下所示：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;notebook&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;qty&quot;</span><span class="punctuation">:</span> <span class="number">50</span> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="（三）确定哪些字段作为嵌入式数据"><a href="#（三）确定哪些字段作为嵌入式数据" class="headerlink" title="（三）确定哪些字段作为嵌入式数据"></a>（三）确定哪些字段作为嵌入式数据</h3><p>接下来，需要确定哪些字段可能需要多个值。可以考虑将这些字段作为嵌入式文档或嵌入式文档中的 列表&#x2F;数组 对象。</p>
<p>例如，在上面的示例中，size 可能包含三个字段：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;h&quot;</span><span class="punctuation">:</span> <span class="number">11</span><span class="punctuation">,</span> <span class="attr">&quot;w&quot;</span><span class="punctuation">:</span> <span class="number">8.5</span><span class="punctuation">,</span> <span class="attr">&quot;uom&quot;</span><span class="punctuation">:</span> <span class="string">&quot;in&quot;</span> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>And some items have multiple ratings, so <code>ratings</code> might be represented as a list of documents containing the field <code>scores</code>:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span><span class="punctuation">&#123;</span> <span class="attr">&quot;score&quot;</span><span class="punctuation">:</span> <span class="number">8</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;score&quot;</span><span class="punctuation">:</span> <span class="number">9</span> <span class="punctuation">&#125;</span><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>

<p>And you might need to handle multiple tags per item. So you might store them in a list too.</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span><span class="string">&quot;college-ruled&quot;</span><span class="punctuation">,</span> <span class="string">&quot;perforated&quot;</span><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>

<p>Finally, a JSON document that stores an inventory item might look like this:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;notebook&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;qty&quot;</span><span class="punctuation">:</span> <span class="number">50</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;rating&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">&#123;</span> <span class="attr">&quot;score&quot;</span><span class="punctuation">:</span> <span class="number">8</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;score&quot;</span><span class="punctuation">:</span> <span class="number">9</span> <span class="punctuation">&#125;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;height&quot;</span><span class="punctuation">:</span> <span class="number">11</span><span class="punctuation">,</span> <span class="attr">&quot;width&quot;</span><span class="punctuation">:</span> <span class="number">8.5</span><span class="punctuation">,</span> <span class="attr">&quot;unit&quot;</span><span class="punctuation">:</span> <span class="string">&quot;in&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="string">&quot;A&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;tags&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;college-ruled&quot;</span><span class="punctuation">,</span> <span class="string">&quot;perforated&quot;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>This looks very different from the tabular data structure you started with in Step 1.</p>
<h2 id="数据模型简介"><a href="#数据模型简介" class="headerlink" title="数据模型简介"></a>数据模型简介</h2><p>数据建模中的关键挑战是平衡应用程序的需求、数据库引擎的性能以及数据检索模式。 在设计数据模型时，始终需要考虑数据的应用程序使用情况（即数据的查询，更新和处理）以及数据本身的固有结构。</p>
<h3 id="灵活的-Schema"><a href="#灵活的-Schema" class="headerlink" title="灵活的 Schema"></a>灵活的 Schema</h3><p>在关系型数据库中，必须在插入数据之前确定并声明表的结构。而 MongoDB 的 collection 默认情况下不需要其文档具有相同的架构。也就是说：</p>
<p>同一个 collection 中的 document 不需要具有相同的 field 集，并且 field 的数据类型可以在集合中的不同文档之间有所不同。</p>
<p>要更改 collection 中的 document 结构，例如添加新 field，删除现有 field 或将 field 值更改为新类型，只需要将文档更新为新结构即可。</p>
<p>这种灵活性有助于将 document 映射到实体或对象。每个 document 都可以匹配所表示实体的数据字段，即使该文档与集合中的其他文档有很大的不同。但是，实际上，集合中的文档具有相似的结构，并且您可以在更新和插入操作期间对 collection 强制执行 document 校验规则。</p>
<h3 id="Document-结构"><a href="#Document-结构" class="headerlink" title="Document 结构"></a>Document 结构</h3><h4 id="嵌入式数据模型"><a href="#嵌入式数据模型" class="headerlink" title="嵌入式数据模型"></a>嵌入式数据模型</h4><p>嵌入式 document 通过将相关数据存储在单个 document 结构中来捕获数据之间的关系。 MongoDB document 可以将 document 结构嵌入到另一个 document 中的字段或数组中。这些非规范化的数据模型允许应用程序在单个数据库操作中检索和操纵相关数据。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/snap/20200910193231.png" alt="img"></p>
<p>对于 MongoDB 中的很多场景，非规范化数据模型都是最佳的。</p>
<blockquote>
<p>嵌入式 document 有大小限制：必须小于 16 MB。</p>
<p>如果是较大的二进制数据，可以考虑 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/core/gridfs/">GridFS</a>。</p>
</blockquote>
<h4 id="引用式数据模型"><a href="#引用式数据模型" class="headerlink" title="引用式数据模型"></a>引用式数据模型</h4><p>引用通过包含从一个 document 到另一个 document 的链接或引用来存储数据之间的关系。 应用程序可以解析这些引用以访问相关数据。 广义上讲，这些是规范化的数据模型。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/snap/20200910193234.png" alt="img"></p>
<p>通常，在以下场景使用引用式的数据模型：</p>
<ul>
<li>嵌入时会导致数据重复，但无法提供足够的读取性能优势，无法胜过重复的含义。</li>
<li>代表更复杂的多对多关系。</li>
<li>为大规模分层数据集建模。</li>
</ul>
<p>为了 join collection，MongoDB 支持聚合 stage：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/operator/aggregation/lookup/#pipe._S_lookup"><code>$lookup</code></a>（MongoDB 3.2 开始支持）</li>
<li><a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/operator/aggregation/graphLookup/#pipe._S_graphLookup"><code>$graphLookup</code></a>（MongoDB 3.4 开始支持）</li>
</ul>
<p>MongoDB 还提供了引用来支持跨集合 join 数据：</p>
<ul>
<li>引用数据模型示例，参考：<a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/tutorial/model-referenced-one-to-many-relationships-between-documents/#data-modeling-publisher-and-books">Model One-to-Many Relationships with Document References</a>.</li>
<li>更多树形模型，参考：<a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/applications/data-models-tree-structures/">Model Tree Structures</a>.</li>
</ul>
<h3 id="原子写操作"><a href="#原子写操作" class="headerlink" title="原子写操作"></a>原子写操作</h3><h4 id="单-document-的原子性"><a href="#单-document-的原子性" class="headerlink" title="单 document 的原子性"></a>单 document 的原子性</h4><p>在 MongoDB 中，针对单个 document 的写操作是原子性的，即使该 document 中嵌入了多个子 document。 具有嵌入数据的非规范化数据模型将所有相关数据合并在一个 document 中，而不是在多个 document 和 collection 中进行规范化。 该数据模型有助于原子操作。 当单个写入操作（例如 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/method/db.collection.updateMany/#db.collection.updateMany"><code>db.collection.updateMany()</code></a>）修改多个 document 时，每个 document 的独立修改是原子的，但整个操作不是原子的。</p>
<h4 id="多-document-事务"><a href="#多-document-事务" class="headerlink" title="多 document 事务"></a>多 document 事务</h4><p>对于需要对多个 document（在单个或多个集合中）进行读写原子性的情况，MongoDB 支持多 document 事务。</p>
<ul>
<li>在版本 4.0 中，MongoDB 在副本集上支持多 document 事务。</li>
<li>在版本 4.2 中，MongoDB 引入了分布式事务，它增加了对分片群集上多 document 事务的支持，并合并了对副本集上多 document 事务的现有支持。</li>
</ul>
<blockquote>
<p>在大多数情况下，多 document 事务会比单 document 的写入产生更高的性能消耗，并且多 document 事务的可用性不能替代高效的结构设计。 在许多情况下，非规范化数据模型（嵌入式 document 和数组）仍是最佳选择。 也就是说，合理的数据建模，将最大程度地减少对多 document 事务的需求。</p>
</blockquote>
<h3 id="数据使用和性能"><a href="#数据使用和性能" class="headerlink" title="数据使用和性能"></a>数据使用和性能</h3><p>在设计数据模型时，请考虑应用程序将如何使用您的数据库。 例如，如果您的应用程序仅使用最近插入的 document，请考虑使用上限集合。 或者，如果您的应用程序主要是对 collection 的读取操作，则添加索引以提高性能。</p>
<h2 id="Schema-校验"><a href="#Schema-校验" class="headerlink" title="Schema 校验"></a>Schema 校验</h2><h3 id="指定校验规则"><a href="#指定校验规则" class="headerlink" title="指定校验规则"></a>指定校验规则</h3><p>如果创建新 collection 时要指定校验规则，需要在使用 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/method/db.createCollection/#db.createCollection"><code>db.createCollection()</code></a> 时指定 <code>validator</code> 选项。</p>
<p>如果要将 document 校验添加到现有 collection 中，需要使用带有 <code>validator</code> 选项的 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/command/collMod/#dbcmd.collMod"><code>collMod</code></a> 命令。</p>
<p>MongoDB 还提供以下相关选项：</p>
<ul>
<li><code>validationLevel</code> 选项（用于确定 MongoDB 在更新过程中，对现有 document 应用校验规则的严格程度）</li>
<li><code>validationAction</code> 选项（用于确定 MongoDB 发现违反校验规则的 document 时，是选择报错并拒绝，还是接受数据但在日志中告警）。</li>
</ul>
<h3 id="JSON-Schema"><a href="#JSON-Schema" class="headerlink" title="JSON Schema"></a>JSON Schema</h3><p>从 3.6 版本开始，MongoDB 开始支持 JSON Schema 校验。</p>
<p>可以通过在 validator 表达式中使用 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/operator/query/jsonSchema/#op._S_jsonSchema"><code>$jsonSchema</code></a> 操作来指定 JSON Schema 校验。</p>
<p>【示例】</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="title function_">createCollection</span>(<span class="string">&#x27;students&#x27;</span>, &#123;</span><br><span class="line">  <span class="attr">validator</span>: &#123;</span><br><span class="line">    <span class="attr">$jsonSchema</span>: &#123;</span><br><span class="line">      <span class="attr">bsonType</span>: <span class="string">&#x27;object&#x27;</span>,</span><br><span class="line">      <span class="attr">required</span>: [<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;year&#x27;</span>, <span class="string">&#x27;major&#x27;</span>, <span class="string">&#x27;address&#x27;</span>],</span><br><span class="line">      <span class="attr">properties</span>: &#123;</span><br><span class="line">        <span class="attr">name</span>: &#123;</span><br><span class="line">          <span class="attr">bsonType</span>: <span class="string">&#x27;string&#x27;</span>,</span><br><span class="line">          <span class="attr">description</span>: <span class="string">&#x27;must be a string and is required&#x27;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">year</span>: &#123;</span><br><span class="line">          <span class="attr">bsonType</span>: <span class="string">&#x27;int&#x27;</span>,</span><br><span class="line">          <span class="attr">minimum</span>: <span class="number">2017</span>,</span><br><span class="line">          <span class="attr">maximum</span>: <span class="number">3017</span>,</span><br><span class="line">          <span class="attr">description</span>: <span class="string">&#x27;must be an integer in [ 2017, 3017 ] and is required&#x27;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">major</span>: &#123;</span><br><span class="line">          <span class="attr">enum</span>: [<span class="string">&#x27;Math&#x27;</span>, <span class="string">&#x27;English&#x27;</span>, <span class="string">&#x27;Computer Science&#x27;</span>, <span class="string">&#x27;History&#x27;</span>, <span class="literal">null</span>],</span><br><span class="line">          <span class="attr">description</span>: <span class="string">&#x27;can only be one of the enum values and is required&#x27;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">gpa</span>: &#123;</span><br><span class="line">          <span class="attr">bsonType</span>: [<span class="string">&#x27;double&#x27;</span>],</span><br><span class="line">          <span class="attr">description</span>: <span class="string">&#x27;must be a double if the field exists&#x27;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">address</span>: &#123;</span><br><span class="line">          <span class="attr">bsonType</span>: <span class="string">&#x27;object&#x27;</span>,</span><br><span class="line">          <span class="attr">required</span>: [<span class="string">&#x27;city&#x27;</span>],</span><br><span class="line">          <span class="attr">properties</span>: &#123;</span><br><span class="line">            <span class="attr">street</span>: &#123;</span><br><span class="line">              <span class="attr">bsonType</span>: <span class="string">&#x27;string&#x27;</span>,</span><br><span class="line">              <span class="attr">description</span>: <span class="string">&#x27;must be a string if the field exists&#x27;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">city</span>: &#123;</span><br><span class="line">              <span class="attr">bsonType</span>: <span class="string">&#x27;string&#x27;</span>,</span><br><span class="line">              <span class="attr">description</span>: <span class="string">&#x27;must be a string and is required&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="其它查询表达式"><a href="#其它查询表达式" class="headerlink" title="其它查询表达式"></a>其它查询表达式</h3><p>除了使用 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/operator/query/jsonSchema/#op._S_jsonSchema"><code>$jsonSchema</code></a> 查询运算符的 JSON Schema 校验外，MongoDB 还支持其它查询运算符的校验，但以下情况除外：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/operator/query/near/#op._S_near"><code>$near</code></a>,</li>
<li><a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/operator/query/nearSphere/#op._S_nearSphere"><code>$nearSphere</code></a>,</li>
<li><a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/operator/query/text/#op._S_text"><code>$text</code></a>,</li>
<li><a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/operator/query/where/#op._S_where"><code>$where</code></a>, and</li>
<li>带有 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/operator/aggregation/function/#exp._S_function"><code>$function</code></a> 表达式的 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/operator/query/expr/#op._S_expr"><code>$expr</code></a></li>
</ul>
<p>【示例】查询表达式中指定校验规则</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="title function_">createCollection</span>(<span class="string">&#x27;contacts&#x27;</span>, &#123;</span><br><span class="line">  <span class="attr">validator</span>: &#123;</span><br><span class="line">    <span class="attr">$or</span>: [</span><br><span class="line">      &#123; <span class="attr">phone</span>: &#123; <span class="attr">$type</span>: <span class="string">&#x27;string&#x27;</span> &#125; &#125;,</span><br><span class="line">      &#123; <span class="attr">email</span>: &#123; <span class="attr">$regex</span>: <span class="regexp">/@mongodb\.com$/</span> &#125; &#125;,</span><br><span class="line">      &#123; <span class="attr">status</span>: &#123; <span class="attr">$in</span>: [<span class="string">&#x27;Unknown&#x27;</span>, <span class="string">&#x27;Incomplete&#x27;</span>] &#125; &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="行为"><a href="#行为" class="headerlink" title="行为"></a>行为</h3><p>校验发生在更新和插入期间。添加校验规则到 collection 时，不会对现有的 document 进行校验，除非发生修改操作。</p>
<h4 id="现有的-document"><a href="#现有的-document" class="headerlink" title="现有的 document"></a>现有的 document</h4><p><code>validationLevel</code> 选项确定 MongoDB 进行规则校验时执行的操作：</p>
<ul>
<li>如果 <code>validationLevel</code> 是 strict（严格级别。这是 MongoDB 默认级别），则 MongoDB 将校验规则应用于所有插入和更新。</li>
<li>如果 <code>validationLevel</code> 是 moderate（中等级别），则 MongoDB 只对已满足校验条件的现有文档的插入和更新操作进行校验；对不符合校验标准的现有文档的更新操作不进行校验。</li>
</ul>
<p>【示例】</p>
<p>下面是一个正常的插入操作：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="property">contacts</span>.<span class="title function_">insert</span>([</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">_id</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;Anne&#x27;</span>,</span><br><span class="line">    <span class="attr">phone</span>: <span class="string">&#x27;+1 555 123 456&#x27;</span>,</span><br><span class="line">    <span class="attr">city</span>: <span class="string">&#x27;London&#x27;</span>,</span><br><span class="line">    <span class="attr">status</span>: <span class="string">&#x27;Complete&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123; <span class="attr">_id</span>: <span class="number">2</span>, <span class="attr">name</span>: <span class="string">&#x27;Ivan&#x27;</span>, <span class="attr">city</span>: <span class="string">&#x27;Vancouver&#x27;</span> &#125;</span><br><span class="line">])</span><br></pre></td></tr></table></figure>

<p>在 collection 上配置一个校验规则：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="title function_">runCommand</span>(&#123;</span><br><span class="line">  <span class="attr">collMod</span>: <span class="string">&#x27;contacts&#x27;</span>,</span><br><span class="line">  <span class="attr">validator</span>: &#123;</span><br><span class="line">    <span class="attr">$jsonSchema</span>: &#123;</span><br><span class="line">      <span class="attr">bsonType</span>: <span class="string">&#x27;object&#x27;</span>,</span><br><span class="line">      <span class="attr">required</span>: [<span class="string">&#x27;phone&#x27;</span>, <span class="string">&#x27;name&#x27;</span>],</span><br><span class="line">      <span class="attr">properties</span>: &#123;</span><br><span class="line">        <span class="attr">phone</span>: &#123;</span><br><span class="line">          <span class="attr">bsonType</span>: <span class="string">&#x27;string&#x27;</span>,</span><br><span class="line">          <span class="attr">description</span>: <span class="string">&#x27;must be a string and is required&#x27;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">name</span>: &#123;</span><br><span class="line">          <span class="attr">bsonType</span>: <span class="string">&#x27;string&#x27;</span>,</span><br><span class="line">          <span class="attr">description</span>: <span class="string">&#x27;must be a string and is required&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">validationLevel</span>: <span class="string">&#x27;moderate&#x27;</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>则 <code>contacts</code> collection 现在添加了含中等级别（moderate） validationLevel 的 <code>validator</code>：</p>
<ul>
<li><p>如果尝试更新 <code>_id</code>为 1 的文档，则 MongoDB 将应用校验规则，因为现有文档符合条件。</p>
</li>
<li><p>相反，MongoDB 不会将校验 <code>_id</code> 为 2 的文档，因为它不符合校验规则。</p>
</li>
</ul>
<p>如果要完全禁用校验，可以将 <code>validationLevel</code> 置为 <code>off</code>。</p>
<h4 id="接受或拒绝无效的-document"><a href="#接受或拒绝无效的-document" class="headerlink" title="接受或拒绝无效的 document"></a>接受或拒绝无效的 document</h4><ul>
<li>如果 validationAction 是 Error（默认），则 MongoDB 拒绝任何违反校验规则的插入或更新。</li>
<li>如果 validationAction 是 Warn，MongoDB 会记录所有的违规，但允许进行插入或更新。</li>
</ul>
<p>【示例】</p>
<p>创建集合时，配置 <code>validationAction</code> 为 warn。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="title function_">createCollection</span>(<span class="string">&#x27;contacts2&#x27;</span>, &#123;</span><br><span class="line">  <span class="attr">validator</span>: &#123;</span><br><span class="line">    <span class="attr">$jsonSchema</span>: &#123;</span><br><span class="line">      <span class="attr">bsonType</span>: <span class="string">&#x27;object&#x27;</span>,</span><br><span class="line">      <span class="attr">required</span>: [<span class="string">&#x27;phone&#x27;</span>],</span><br><span class="line">      <span class="attr">properties</span>: &#123;</span><br><span class="line">        <span class="attr">phone</span>: &#123;</span><br><span class="line">          <span class="attr">bsonType</span>: <span class="string">&#x27;string&#x27;</span>,</span><br><span class="line">          <span class="attr">description</span>: <span class="string">&#x27;must be a string and is required&#x27;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">email</span>: &#123;</span><br><span class="line">          <span class="attr">bsonType</span>: <span class="string">&#x27;string&#x27;</span>,</span><br><span class="line">          <span class="attr">pattern</span>: <span class="string">&#x27;@mongodb.com$&#x27;</span>,</span><br><span class="line">          <span class="attr">description</span>:</span><br><span class="line">            <span class="string">&#x27;must be a string and match the regular expression pattern&#x27;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">status</span>: &#123;</span><br><span class="line">          <span class="attr">enum</span>: [<span class="string">&#x27;Unknown&#x27;</span>, <span class="string">&#x27;Incomplete&#x27;</span>],</span><br><span class="line">          <span class="attr">description</span>: <span class="string">&#x27;can only be one of the enum values&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">validationAction</span>: <span class="string">&#x27;warn&#x27;</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>尝试插入一条违规记录</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.<span class="property">contacts2</span>.<span class="title function_">insert</span>( &#123; <span class="attr">name</span>: <span class="string">&quot;Amanda&quot;</span>, <span class="attr">status</span>: <span class="string">&quot;Updated&quot;</span> &#125; )</span><br><span class="line"><span class="title class_">WriteResult</span>(&#123; <span class="string">&quot;nInserted&quot;</span> : <span class="number">1</span> &#125;)</span><br></pre></td></tr></table></figure>

<p>MongoDB 允许这条操作执行，但是服务器会记录下告警信息。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&quot;t&quot;</span>:&#123;<span class="string">&quot;<span class="variable">$date</span>&quot;</span>:<span class="string">&quot;2020-09-11T16:35:57.754+08:00&quot;</span>&#125;,<span class="string">&quot;s&quot;</span>:<span class="string">&quot;W&quot;</span>,  <span class="string">&quot;c&quot;</span>:<span class="string">&quot;STORAGE&quot;</span>,  <span class="string">&quot;id&quot;</span>:20294,   <span class="string">&quot;ctx&quot;</span>:<span class="string">&quot;conn14&quot;</span>,<span class="string">&quot;msg&quot;</span>:<span class="string">&quot;Document would fail validation&quot;</span>,<span class="string">&quot;attr&quot;</span>:&#123;<span class="string">&quot;namespace&quot;</span>:<span class="string">&quot;test.contacts2&quot;</span>,<span class="string">&quot;document&quot;</span>:&#123;<span class="string">&quot;_id&quot;</span>:&#123;<span class="string">&quot;<span class="variable">$oid</span>&quot;</span>:<span class="string">&quot;5f5b36ed8ea53d62a0b51c4e&quot;</span>&#125;,<span class="string">&quot;name&quot;</span>:<span class="string">&quot;Amanda&quot;</span>,<span class="string">&quot;status&quot;</span>:<span class="string">&quot;Updated&quot;</span>&#125;&#125;&#125;</span><br></pre></td></tr></table></figure>

<h4 id="限制"><a href="#限制" class="headerlink" title="限制"></a>限制</h4><p>不能在 <code>admin</code>、<code>local</code>、<code>config</code> 这几个特殊的数据库中指定校验规则。</p>
<p>不能在 <code>system.*</code> collection 中指定校验。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><strong>官方</strong><ul>
<li><a target="_blank" rel="noopener" href="https://www.mongodb.com/">MongoDB 官网</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/mongodb/mongo">MongoDB Github</a></li>
<li><a target="_blank" rel="noopener" href="https://university.mongodb.com/">MongoDB 官方免费教程</a></li>
</ul>
</li>
<li><strong>教程</strong><ul>
<li><a target="_blank" rel="noopener" href="https://www.runoob.com/mongodb/mongodb-tutorial.html">MongoDB 教程</a></li>
<li><a target="_blank" rel="noopener" href="https://time.geekbang.org/course/intro/100040001">MongoDB 高手课</a></li>
</ul>
</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/pages/5e3c30/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/avatar.gif">
      <meta itemprop="name" content="钝悟 ◾ Dunwu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu Blog">
      <meta itemprop="description" content="钝悟的个人博客">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Dunwu Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/pages/5e3c30/" class="post-title-link" itemprop="url">MongoDB 运维</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-09-09 20:47:14" itemprop="dateCreated datePublished" datetime="2020-09-09T20:47:14+08:00">2020-09-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-09-23 18:54:25" itemprop="dateModified" datetime="2022-09-23T18:54:25+08:00">2022-09-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">数据库</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/%E6%96%87%E6%A1%A3%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">文档数据库</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/%E6%96%87%E6%A1%A3%E6%95%B0%E6%8D%AE%E5%BA%93/MongoDB/" itemprop="url" rel="index"><span itemprop="name">MongoDB</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>6.8k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>6 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="MongoDB-运维"><a href="#MongoDB-运维" class="headerlink" title="MongoDB 运维"></a>MongoDB 运维</h1><h2 id="MongoDB-安装"><a href="#MongoDB-安装" class="headerlink" title="MongoDB 安装"></a>MongoDB 安装</h2><h3 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h3><p>（1）下载并解压到本地</p>
<p>进入官网下载地址：<a target="_blank" rel="noopener" href="https://www.mongodb.com/try/download/community"><strong>官方下载地址</strong></a> ，选择合适的版本下载。</p>
<p>（2）创建数据目录</p>
<p>MongoDB 将数据目录存储在 db 目录下。但是这个数据目录不会主动创建，我们在安装完成后需要创建它。</p>
<p>例如：<code>D:\Tools\Server\mongodb\mongodb-4.4.0\data\db</code></p>
<p>（3）运行 MongoDB 服务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongod --dbpath D:\Tools\Server\mongodb\mongodb-4.4.0\data\db</span><br></pre></td></tr></table></figure>

<p>（4）客户端连接 MongoDB</p>
<p>可以在命令窗口中运行 mongo.exe 命令即可连接上 MongoDB</p>
<p>（5）配置 MongoDB 服务</p>
<h3 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h3><p>（1）使用安装包安装</p>
<p>安装前我们需要安装各个 Linux 平台依赖包。</p>
<p><strong>Red Hat&#x2F;CentOS：</strong></p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum <span class="keyword">install</span> libcurl openssl</span><br></pre></td></tr></table></figure>

<p><strong>Ubuntu 18.04 LTS (“Bionic”)&#x2F;Debian 10 “Buster”：</strong></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-<span class="built_in">get</span> install libcurl4 openssl</span><br></pre></td></tr></table></figure>

<p><strong>Ubuntu 16.04 LTS (“Xenial”)&#x2F;Debian 9 “Stretch”：</strong></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-<span class="built_in">get</span> install libcurl3 openssl</span><br></pre></td></tr></table></figure>

<p>（2）创建数据目录</p>
<p>默认情况下 MongoDB 启动后会初始化以下两个目录：</p>
<ul>
<li>数据存储目录：&#x2F;var&#x2F;lib&#x2F;mongodb</li>
<li>日志文件目录：&#x2F;var&#x2F;log&#x2F;mongodb</li>
</ul>
<p>我们在启动前可以先创建这两个目录并设置当前用户有读写权限：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir -p /var/lib/mongo</span><br><span class="line">sudo mkdir -p /var/log/mongodb</span><br><span class="line">sudo chown `whoami` /var/lib/mongo     # 设置权限</span><br><span class="line">sudo chown `whoami` /var/log/mongodb   # 设置权限</span><br></pre></td></tr></table></figure>

<p>（3）运行 MongoDB 服务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongod --dbpath /var/lib/mongo --logpath /var/log/mongodb/mongod.log --fork</span><br></pre></td></tr></table></figure>

<p>打开 &#x2F;var&#x2F;log&#x2F;mongodb&#x2F;mongod.log 文件看到以下信息，说明启动成功。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">tail</span> -10f /var/log/mongodb/mongod.log</span></span><br><span class="line">2020-07-09T12:20:17.391+0800 I  NETWORK  [listener] Listening on /tmp/mongodb-27017.sock</span><br><span class="line">2020-07-09T12:20:17.392+0800 I  NETWORK  [listener] Listening on 127.0.0.1</span><br><span class="line">2020-07-09T12:20:17.392+0800 I  NETWORK  [listener] waiting for connections on port 27017</span><br></pre></td></tr></table></figure>

<p>（4）客户端连接 MongoDB</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/mongodb4/bin</span><br><span class="line">./mongo</span><br></pre></td></tr></table></figure>

<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/dunwu/linux-tutorial/tree/master/codes/linux/soft">Linux 安装脚本</a></p>
</blockquote>
<h3 id="设置用户名、密码"><a href="#设置用户名、密码" class="headerlink" title="设置用户名、密码"></a>设置用户名、密码</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">use admin</span></span><br><span class="line">switched to db admin</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">db.createUser(&#123;<span class="string">&quot;user&quot;</span>:<span class="string">&quot;root&quot;</span>,<span class="string">&quot;pwd&quot;</span>:<span class="string">&quot;root&quot;</span>,<span class="string">&quot;roles&quot;</span>:[&#123;<span class="string">&quot;role&quot;</span>:<span class="string">&quot;userAdminAnyDatabase&quot;</span>,<span class="string">&quot;db&quot;</span>:<span class="string">&quot;admin&quot;</span>&#125;]&#125;)</span></span><br><span class="line">Successfully added user: &#123;</span><br><span class="line">        &quot;user&quot; : &quot;root&quot;,</span><br><span class="line">        &quot;roles&quot; : [</span><br><span class="line">                &#123;</span><br><span class="line">                        &quot;role&quot; : &quot;userAdminAnyDatabase&quot;,</span><br><span class="line">                        &quot;db&quot; : &quot;admin&quot;</span><br><span class="line">                &#125;</span><br><span class="line">        ]</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_">&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="备份和恢复"><a href="#备份和恢复" class="headerlink" title="备份和恢复"></a>备份和恢复</h2><h3 id="数据备份"><a href="#数据备份" class="headerlink" title="数据备份"></a>数据备份</h3><p>在 Mongodb 中，使用 <code>mongodump</code> 命令来备份 MongoDB 数据。该命令可以导出所有数据到指定目录中。</p>
<p><code>mongodump</code> 命令可以通过参数指定导出的数据量级转存的服务器。</p>
<p>mongodump 命令语法如下：</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">mongodump -h dbhost -d dbname -o dbdirectory</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>-h：MongDB 所在服务器地址，例如：127.0.0.1，当然也可以指定端口号：127.0.0.1:27017</p>
</li>
<li><p>-d：需要备份的数据库实例，例如：test</p>
</li>
<li><p>-o：备份的数据存放位置，例如：c:\data\dump，当然该目录需要提前建立，在备份完成后，系统自动在 dump 目录下建立一个 test 目录，这个目录里面存放该数据库实例的备份数据。</p>
</li>
</ul>
<p><code>mongodump</code> 命令可选参数列表如下所示：</p>
<table>
<thead>
<tr>
<th align="left">语法</th>
<th align="left">描述</th>
<th align="left">实例</th>
</tr>
</thead>
<tbody><tr>
<td align="left">mongodump –host HOST_NAME –port PORT_NUMBER</td>
<td align="left">该命令将备份所有 MongoDB 数据</td>
<td align="left">mongodump –host runoob.com –port 27017</td>
</tr>
<tr>
<td align="left">mongodump –dbpath DB_PATH –out BACKUP_DIRECTORY</td>
<td align="left"></td>
<td align="left">mongodump –dbpath &#x2F;data&#x2F;db&#x2F; –out &#x2F;data&#x2F;backup&#x2F;</td>
</tr>
<tr>
<td align="left">mongodump –collection COLLECTION –db DB_NAME</td>
<td align="left">该命令将备份指定数据库的集合。</td>
<td align="left">mongodump –collection mycol –db test</td>
</tr>
</tbody></table>
<p>【示例】备份全量数据</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">mongodump -h 127.0.0.1 --port 27017 -o test2</span></span><br><span class="line">...</span><br><span class="line">2020-09-11T11:55:58.086+0800    done dumping test.company (18801 documents)</span><br><span class="line">2020-09-11T11:56:00.725+0800    [#############...........]  test.people  559101/1000000  (55.9%)</span><br><span class="line">2020-09-11T11:56:03.725+0800    [###################.....]  test.people  829496/1000000  (82.9%)</span><br><span class="line">2020-09-11T11:56:06.725+0800    [#####################...]  test.people  884614/1000000  (88.5%)</span><br><span class="line">2020-09-11T11:56:08.088+0800    [########################]  test.people  1000000/1000000  (100.0%)</span><br><span class="line">2020-09-11T11:56:08.350+0800    done dumping test.people (1000000 documents)</span><br></pre></td></tr></table></figure>

<p>【示例】备份指定数据库</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongodump -h 127.0.0.1 --port 27017 -d admin -o test3</span><br></pre></td></tr></table></figure>

<h3 id="数据恢复"><a href="#数据恢复" class="headerlink" title="数据恢复"></a>数据恢复</h3><p>mongodb 使用 <code>mongorestore</code> 命令来恢复备份的数据。</p>
<p><code>mongorestore</code> 命令语法如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">mongorestore -h &lt;hostname&gt;&lt;:port&gt; -d dbname &lt;path&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>--host &lt;:port&gt;</code>, <code>-h &lt;:port&gt;</code>：MongoDB 所在服务器地址，默认为： localhost:27017</p>
</li>
<li><p><code>--db</code> , <code>-d</code> ：需要恢复的数据库实例，例如：test，当然这个名称也可以和备份时候的不一样，比如 test2</p>
</li>
<li><p><code>--drop</code>：恢复的时候，先删除当前数据，然后恢复备份的数据。就是说，恢复后，备份后添加修改的数据都会被删除，慎用哦！</p>
</li>
<li><p><code>&lt;path&gt;</code>：mongorestore 最后的一个参数，设置备份数据所在位置，例如：c:\data\dump\test。你不能同时指定 <code>&lt;path&gt;</code> 和 <code>--dir</code> 选项，<code>--dir</code> 也可以设置备份目录。</p>
</li>
<li><p><code>--dir</code>：指定备份的目录。你不能同时指定 <code>&lt;path&gt;</code> 和 <code>--dir</code> 选项。</p>
</li>
</ul>
<p>【示例】</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">mongorestore -h 127.0.0.1 --port 27017 -d <span class="built_in">test</span> --<span class="built_in">dir</span> <span class="built_in">test</span> --drop</span></span><br><span class="line">...</span><br><span class="line">2020-09-11T11:46:16.053+0800    finished restoring test.tweets (966 documents, 0 failures)</span><br><span class="line">2020-09-11T11:46:18.256+0800    [###.....................]  test.people  164MB/1.03GB  (15.6%)</span><br><span class="line">2020-09-11T11:46:21.255+0800    [########................]  test.people  364MB/1.03GB  (34.6%)</span><br><span class="line">2020-09-11T11:46:24.256+0800    [############............]  test.people  558MB/1.03GB  (53.0%)</span><br><span class="line">2020-09-11T11:46:27.255+0800    [###############.........]  test.people  700MB/1.03GB  (66.5%)</span><br><span class="line">2020-09-11T11:46:30.257+0800    [###################.....]  test.people  846MB/1.03GB  (80.3%)</span><br><span class="line">2020-09-11T11:46:33.255+0800    [######################..]  test.people  990MB/1.03GB  (94.0%)</span><br><span class="line">2020-09-11T11:46:34.542+0800    [########################]  test.people  1.03GB/1.03GB  (100.0%)</span><br><span class="line">2020-09-11T11:46:34.543+0800    no indexes to restore</span><br><span class="line">2020-09-11T11:46:34.543+0800    finished restoring test.people (1000000 documents, 0 failures)</span><br><span class="line">2020-09-11T11:46:34.544+0800    1000966 document(s) restored successfully. 0 document(s) failed to restore.</span><br></pre></td></tr></table></figure>

<h2 id="导入导出"><a href="#导入导出" class="headerlink" title="导入导出"></a>导入导出</h2><p><code>mongoimport</code> 和 <code>mongoexport</code> 并不能可靠地保存所有的富文本 BSON 数据类型，因为 JSON 仅能代表一种 BSON 支持的子集类型。因此，数据用这些工具导出导入或许会丢失一些精确程度。</p>
<h3 id="导入操作"><a href="#导入操作" class="headerlink" title="导入操作"></a>导入操作</h3><p>在 MongoDB 中，使用 <code>mongoimport</code> 来导入数据。 默认情况下，<code>mongoimport</code> 会将数据导入到本地主机端口 27017 上的 MongoDB 实例中。要将数据导入在其他主机或端口上运行的 MongoDB 实例中，请通过包含 <code>--host</code> 和 <code>--port</code> 选项来指定主机名或端口。 使用 <code>--drop</code> 选项删除集合（如果已经存在）。 这样可以确保该集合仅包含您要导入的数据。</p>
<p>语法格式：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongoimport -h IP --port 端口 -u 用户名 -p 密码 -d 数据库 -c 表名 --<span class="built_in">type</span> 类型 --headerline --upsert --drop 文件名</span><br></pre></td></tr></table></figure>

<p>【示例】导入表数据</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">mongoimport -h 127.0.0.1 --port 27017 -d <span class="built_in">test</span> -c book --drop <span class="built_in">test</span>/book.dat</span></span><br><span class="line">2020-09-11T10:53:56.359+0800    connected to: mongodb://127.0.0.1:27017/</span><br><span class="line">2020-09-11T10:53:56.372+0800    dropping: test.book</span><br><span class="line">2020-09-11T10:53:56.628+0800    431 document(s) imported successfully. 0 document(s) failed to import.</span><br></pre></td></tr></table></figure>

<p>【示例】从 json 文件中导入表数据</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">mongoimport -h 127.0.0.1 --port 27017 -d <span class="built_in">test</span> -c student --upsert <span class="built_in">test</span>/student.json</span></span><br><span class="line">2020-09-11T11:02:55.907+0800    connected to: mongodb://127.0.0.1:27017/</span><br><span class="line">2020-09-11T11:02:56.068+0800    200 document(s) imported successfully. 0 document(s) failed to import.</span><br></pre></td></tr></table></figure>

<p>【示例】从 csv 文件中导入表数据</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">mongoimport -h 127.0.0.1 --port 27017 -d <span class="built_in">test</span> -c product --<span class="built_in">type</span> csv --headerline <span class="built_in">test</span>/product.csv</span></span><br><span class="line">2020-09-11T11:07:49.788+0800    connected to: mongodb://127.0.0.1:27017/</span><br><span class="line">2020-09-11T11:07:51.051+0800    11 document(s) imported successfully. 0 document(s) failed to import.</span><br></pre></td></tr></table></figure>

<p>【示例】导入部分表字段数据</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">mongoimport -h 127.0.0.1 --port 27017 -d <span class="built_in">test</span> -c product --<span class="built_in">type</span> json --upsertFields name,price <span class="built_in">test</span>/product.json</span></span><br><span class="line">2020-09-11T11:14:05.410+0800    connected to: mongodb://127.0.0.1:27017/</span><br><span class="line">2020-09-11T11:14:05.612+0800    11 document(s) imported successfully. 0 document(s) failed to import.</span><br></pre></td></tr></table></figure>

<h3 id="导出操作"><a href="#导出操作" class="headerlink" title="导出操作"></a>导出操作</h3><p>语法格式：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongoexport -h &lt;IP&gt; --port &lt;端口&gt; -u &lt;用户名&gt; -p &lt;密码&gt; -d &lt;数据库&gt; -c &lt;表名&gt; -f &lt;字段&gt; -q &lt;条件导出&gt; --csv -o &lt;文件名&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>-f</code>：导出指字段，以逗号分割，<code>-f name,email,age</code> 导出 name,email,age 这三个字段</li>
<li><code>-q</code>：可以根查询条件导出，<code>-q &#39;&#123; &quot;uid&quot; : &quot;100&quot; &#125;&#39;</code> 导出 uid 为 100 的数据</li>
<li><code>--csv</code>：表示导出的文件格式为 csv 的，这个比较有用，因为大部分的关系型数据库都是支持 csv，在这里有共同点</li>
</ul>
<p>【示例】导出整张表</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">mongoexport -h 127.0.0.1 --port 27017 -d <span class="built_in">test</span> -c product -o <span class="built_in">test</span>/product.dat</span></span><br><span class="line">2020-09-11T10:44:23.161+0800    connected to: mongodb://127.0.0.1:27017/</span><br><span class="line">2020-09-11T10:44:23.177+0800    exported 11 records</span><br></pre></td></tr></table></figure>

<p>【示例】导出表到 json 文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">mongoexport -h 127.0.0.1 --port 27017 -d <span class="built_in">test</span> -c product --<span class="built_in">type</span> json -o <span class="built_in">test</span>/product.json</span></span><br><span class="line">2020-09-11T10:49:52.735+0800    connected to: mongodb://127.0.0.1:27017/</span><br><span class="line">2020-09-11T10:49:52.750+0800    exported 11 records</span><br></pre></td></tr></table></figure>

<p>【示例】导出表中部分字段到 csv 文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">mongoexport -h 127.0.0.1 --port 27017 -d <span class="built_in">test</span> -c product --<span class="built_in">type</span> csv -f name,price -o <span class="built_in">test</span>/product.csv</span></span><br><span class="line">2020-09-11T10:47:33.160+0800    connected to: mongodb://127.0.0.1:27017/</span><br><span class="line">2020-09-11T10:47:33.176+0800    exported 11 records</span><br></pre></td></tr></table></figure>

<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.mongodb.com/">MongoDB 官网</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/mongodb/mongo">MongoDB Github</a></li>
<li><a target="_blank" rel="noopener" href="https://university.mongodb.com/">MongoDB 官方免费教程</a></li>
<li><a target="_blank" rel="noopener" href="https://www.runoob.com/mongodb/mongodb-tutorial.html">MongoDB 教程</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/blog/page/14/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/blog/">1</a><span class="space">&hellip;</span><a class="page-number" href="/blog/page/14/">14</a><span class="page-number current">15</span><a class="page-number" href="/blog/page/16/">16</a><span class="space">&hellip;</span><a class="page-number" href="/blog/page/37/">37</a><a class="extend next" rel="next" href="/blog/page/16/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2015 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">钝悟 ◾ Dunwu</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>站点总字数：</span>
    <span title="站点总字数">2.8m</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">42:59</span>
  </span>
</div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/blog/js/comments.js"></script><script src="/blog/js/utils.js"></script><script src="/blog/js/motion.js"></script><script src="/blog/js/next-boot.js"></script>

  
<script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/blog/js/third-party/search/local-search.js"></script>




  <script src="/blog/js/third-party/pace.js"></script>

  




<script src="https://unpkg.com/darkmode-js@1.5.7/lib/darkmode-js.min.js"></script>

<script>
var options = {
  bottom: '64px',
  right: 'unset',
  left: '32px',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#100f2c',
  buttonColorLight: '#fff',
  saveInCookies: true,
  label: '🌓',
  autoMatchOsTheme: true
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
</script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.8.0/dist/gitalk.css" integrity="sha256-AJnUHL7dBv6PGaeyPQJcgQPDjt/Hn/PvYZde1iqfp8U=" crossorigin="anonymous">

<script class="next-config" data-name="gitalk" type="application/json">{"enable":true,"github_id":"dunwu","repo":"blog","client_id":"c45bc13ca1d3d3aa4836","client_secret":"1907a9f0c22087badad3938e1d7dcba9078f88ac","admin_user":"dunwu","distraction_free_mode":true,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token","language":"zh-CN","js":{"url":"https://cdn.jsdelivr.net/npm/gitalk@1.8.0/dist/gitalk.min.js","integrity":"sha256-MVK9MGD/XJaGyIghSVrONSnoXoGh3IFxLw0zfvzpxR4="},"path_md5":"df3612dbe1e8a41c4d8b8016252bb5bd"}</script>
<script src="/blog/js/third-party/comments/gitalk.js"></script>

</body>
</html>
